<!DOCTYPE html>
<html lang="zh-CN" data-theme="nebula">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#0f172a">
    <meta name="description" content="Nebula Quill: A local-first AI writing IDE.">
    <title>æ˜Ÿäº‘ç¬”å°– v4.0 (Pro) - Gemini ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600;700&family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%236366f1;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%23a855f7;stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Ccircle cx='50' cy='50' r='48' fill='%231e293b' stroke='url(%23grad)' stroke-width='3'/%3E%3Cpath d='M50 20 L72 55 Q80 70 50 85 Q20 70 28 55 Z' fill='url(%23grad)'/%3E%3C/svg%3E">

    <style>
        /* --- æ ¸å¿ƒä¸»é¢˜ç³»ç»Ÿ --- */
        :root { --bg-color: #0b0e14; --text-main: #e2e8f0; --text-sub: #94a3b8; --panel-bg: rgba(30, 41, 59, 0.4); --panel-border: rgba(255, 255, 255, 0.06); --accent-primary: #818cf8; --accent-secondary: #c084fc; --accent-glow: rgba(129, 140, 248, 0.5); --input-bg: rgba(0, 0, 0, 0.2); --scrollbar-thumb: rgba(255, 255, 255, 0.1); --nav-height: 64px; }
        [data-theme='nebula'] { --bg-image: radial-gradient(circle at 10% 20%, rgba(49,46,129,0.4), transparent 40%), radial-gradient(circle at 90% 80%, rgba(88,28,135,0.3), transparent 40%), linear-gradient(to bottom, #0f172a, #020617); --panel-bg: rgba(15,23,42,0.6); --accent-primary: #818cf8; --accent-secondary: #6366f1; }
        [data-theme='crystal'] { --bg-color: #081b29; --bg-image: radial-gradient(circle at 50% 0%, rgba(34,211,238,0.15), transparent 50%), linear-gradient(135deg, #0f172a 0%, #111827 100%); --panel-bg: rgba(255,255,255,0.03); --panel-border: rgba(255,255,255,0.12); --accent-primary: #22d3ee; --accent-secondary: #06b6d4; --text-main: #f0f9ff; }
        [data-theme='dawn'] { --bg-color: #fff1f2; --bg-image: linear-gradient(120deg, #fff1f2 0%, #ffe4e6 100%); --text-main: #334155; --text-sub: #64748b; --panel-bg: rgba(255,255,255,0.65); --panel-border: rgba(244,114,182,0.2); --accent-primary: #db2777; --accent-secondary: #be185d; --input-bg: rgba(255,255,255,0.5); --scrollbar-thumb: rgba(0,0,0,0.1); }
        [data-theme='cyber'] { --bg-color: #000000; --bg-image: linear-gradient(90deg, rgba(20,20,20,0.5) 1px, transparent 1px), linear-gradient(rgba(20,20,20,0.5) 1px, transparent 1px); background-size: 40px 40px; --panel-bg: rgba(10,10,10,0.9); --panel-border: #333; --accent-primary: #2dd4bf; --accent-secondary: #0d9488; --input-bg: #000; }
        [data-theme='ink'] { --bg-color: #f5f5f4; --bg-image: radial-gradient(#e7e5e4 1px, transparent 1px); background-size: 20px 20px; --text-main: #1c1917; --text-sub: #57534e; --panel-bg: rgba(255,255,255,0.85); --panel-border: rgba(0,0,0,0.08); --accent-primary: #44403c; --accent-secondary: #292524; --input-bg: #fff; --scrollbar-thumb: rgba(0,0,0,0.15); }

        body { font-family: 'Inter', sans-serif; background-color: var(--bg-color); background-image: var(--bg-image); background-attachment: fixed; color: var(--text-main); transition: all 0.5s ease; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
        #bg-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; }
        .serif-font { font-family: 'Noto Serif SC', serif; } .mono-font { font-family: 'JetBrains Mono', monospace; }
        .glass-panel { background: var(--panel-bg); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px); border: 1px solid var(--panel-border); box-shadow: 0 8px 32px -8px rgba(0,0,0,0.15); border-radius: 1.5rem; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .glass-input { background: var(--input-bg); border: 1px solid transparent; color: var(--text-main); transition: all 0.2s; width: 100%; }
        .glass-input:focus { outline: none; border-color: var(--accent-primary); box-shadow: 0 0 0 1px var(--accent-primary); background: var(--panel-bg); }
        .btn-gradient { background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); color: white; transition: all 0.3s; }
        .btn-gradient:hover { transform: translateY(-1px); box-shadow: 0 8px 20px rgba(0,0,0,0.2); filter: brightness(1.1); }
        .btn-ghost { background: transparent; border: 1px solid var(--panel-border); color: var(--text-sub); transition: all 0.2s; }
        .btn-ghost:hover { border-color: var(--accent-primary); color: var(--text-main); background: var(--panel-bg); }
        .btn-accent { background: var(--accent-primary); color: white; transition: all 0.2s; }
        .btn-accent:hover { filter: brightness(1.1); transform: translateY(-1px); }
        .text-accent { color: var(--accent-primary) !important; }
        .card-active { border-color: var(--accent-primary); background: linear-gradient(135deg, var(--panel-bg), rgba(var(--accent-primary), 0.1)); box-shadow: 0 0 20px rgba(var(--accent-primary), 0.2); }
        .blur-content { filter: blur(8px); pointer-events: none; user-select: none; }
        .fade-in { animation: fadeIn 0.5s ease-out; } @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* Chips & Tags */
        .lore-chip { display: inline-flex; align-items: center; gap: 6px; padding: 5px 10px; background: rgba(0,0,0,0.2); border: 1px solid var(--panel-border); border-radius: 8px; cursor: pointer; transition: all 0.2s; color: var(--text-sub); font-size: 0.75rem; white-space: nowrap; user-select: none; }
        .lore-chip:hover { background: var(--panel-bg); border-color: var(--accent-primary); color: var(--text-main); }
        .novel-tag { background: rgba(var(--accent-primary), 0.1); border: 1px solid var(--panel-border); color: var(--text-main); font-size: 0.75rem; padding: 3px 10px; border-radius: 99px; display: inline-flex; align-items: center; gap: 6px; cursor: default; }
        .tag-remove:hover { color: #f43f5e; cursor: pointer; }
        .tag-selectable { background: var(--input-bg); border: 1px solid transparent; padding: 5px 12px; border-radius: 8px; font-size: 0.8rem; cursor: pointer; transition: all 0.2s; color: var(--text-sub); }
        .tag-selectable.selected { background-color: var(--accent-primary); color: white; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        /* UI Elements */
        .announcement-important { border-left: 4px solid #f59e0b; background: linear-gradient(90deg, rgba(245, 158, 11, 0.15), transparent); }
        ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-track { background: transparent; } ::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 99px; } ::-webkit-scrollbar-thumb:hover { background: var(--accent-primary); }
        /* Zen Mode */
        body.zen-mode #bg-canvas, body.zen-mode nav, body.zen-mode #main-content > div:not(#section-loom), body.zen-mode footer, body.zen-mode #pet-container, body.zen-mode #theme-menu, body.zen-mode #section-outline { display: none !important; }
        body.zen-mode #section-loom { display: block; position: fixed; inset: 0; z-index: 50; padding: 0; margin: 0; background: var(--bg-color); height: 100dvh; }
        body.zen-mode #loom-panel { height: 100dvh; border: none; border-radius: 0; background: transparent; box-shadow: none; }
        body.zen-mode #chapter-editor { font-size: 1.25rem; line-height: 2; max-width: 900px; margin: 0 auto; padding-top: 5vh; height: calc(100% - 20px); }
        /* AI Toolbar */
        #ai-toolbar { position: fixed; z-index: 1000; background: var(--panel-bg); backdrop-filter: blur(16px); border: 1px solid var(--panel-border); border-radius: 12px; padding: 4px; display: flex; gap: 4px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.3); transform: translateY(10px); opacity: 0; pointer-events: none; transition: all 0.2s; }
        #ai-toolbar.visible { transform: translateY(0); opacity: 1; pointer-events: auto; }
        /* Pet */
        #pet-container { position: fixed; bottom: 20px; right: 20px; width: 100px; height: 100px; z-index: 999; pointer-events: none; }
        #pet-body { width: 60px; height: 60px; background: radial-gradient(circle at 30% 30%, var(--accent-primary), var(--accent-secondary)); border-radius: 50%; position: absolute; bottom: 10px; right: 10px; box-shadow: 0 0 20px var(--accent-primary); pointer-events: auto; cursor: pointer; transition: transform 0.2s; animation: pet-float 3s ease-in-out infinite; }
        #pet-bubble { position: absolute; bottom: 80px; right: 0; background: var(--panel-bg); border: 1px solid var(--panel-border); color: var(--text-main); font-size: 0.75rem; padding: 8px 12px; border-radius: 12px 12px 0 12px; width: 160px; opacity: 0; transform: scale(0.8); transition: all 0.3s; pointer-events: none; }
        #pet-bubble.show { opacity: 1; transform: scale(1); }
        @keyframes pet-float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }
        .pet-happy { animation: pet-jump 0.5s infinite !important; }
        @keyframes pet-jump { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
    </style>
</head>
<body class="min-h-screen flex flex-col selection:bg-indigo-500/30">

    <canvas id="bg-canvas"></canvas>
    
    <button id="zen-exit-btn" onclick="toggleZenMode()" class="hidden fixed top-5 right-5 z-[60] btn-ghost px-4 py-2 rounded-full border border-red-500/30 text-red-400 font-bold backdrop-blur-md">âœ• é€€å‡ºç¦…æ¨¡å¼</button>

    <div id="ai-toolbar">
        <button onclick="aiAssist('polish')" class="ai-tool-btn p-2 text-xs hover:bg-white/10 rounded">âœ¨ æ¶¦è‰²</button>
        <button onclick="aiAssist('expand')" class="ai-tool-btn p-2 text-xs hover:bg-white/10 rounded">ğŸ” æ‰©å†™</button>
        <button onclick="aiAssist('shorten')" class="ai-tool-btn p-2 text-xs hover:bg-white/10 rounded">âœ‚ï¸ ç²¾ç®€</button>
        <div class="w-px h-4 bg-white/10 mx-1"></div>
        <button onclick="aiAssist('synonym')" class="ai-tool-btn p-2 text-xs hover:bg-white/10 rounded">ğŸ”„ æ¢è¯</button>
    </div>

    <nav class="w-full h-16 fixed top-0 z-[100] glass-panel border-t-0 border-x-0 border-b border-[var(--panel-border)] flex items-center shadow-sm backdrop-blur-md !rounded-none">
        <div class="max-w-[1400px] mx-auto w-full px-4 md:px-6 flex justify-between items-center h-full">
            <div class="flex items-center gap-3 select-none">
                <div class="w-9 h-9 rounded-xl bg-gradient-to-br from-[var(--accent-primary)] to-[var(--accent-secondary)] flex items-center justify-center text-white shadow-lg text-lg">âœ’ï¸</div>
                <div><h1 class="text-base md:text-lg font-bold tracking-widest serif-font text-accent leading-none">æ˜Ÿäº‘ç¬”å°–</h1><span class="text-[10px] text-sub tracking-widest opacity-60">v4.0 Pro</span></div>
            </div>
            
            <div class="flex items-center gap-3">
                <div id="engine-status" class="flex items-center gap-2 px-3 py-1.5 rounded-lg border border-[var(--panel-border)] bg-[var(--input-bg)]">
                    <span class="w-2 h-2 rounded-full bg-gray-500" id="engine-dot"></span>
                    <span id="engine-name" class="text-xs font-mono text-sub">No Key</span>
                </div>
                
                <div class="relative">
                    <button onclick="toggleThemeMenu()" id="theme-btn" class="p-2 rounded-xl hover:bg-[var(--panel-border)] transition text-lg opacity-70 hover:opacity-100">âš™ï¸</button>
                    <div id="theme-menu" class="absolute right-0 mt-4 w-52 glass-panel rounded-xl hidden shadow-2xl z-[101] p-1 border border-[var(--panel-border)]">
                        <div class="px-3 py-2 text-[10px] text-sub font-bold uppercase tracking-wider opacity-60">è®¾ç½®ä¸ä¸»é¢˜</div>
                        <button onclick="changeTheme('nebula')" class="w-full text-left px-3 py-2 text-xs text-sub hover:text-main hover:bg-[var(--panel-bg)] rounded-lg">ğŸŒŒ æ˜Ÿæ²³ (Nebula)</button>
                        <button onclick="changeTheme('crystal')" class="w-full text-left px-3 py-2 text-xs text-sub hover:text-main hover:bg-[var(--panel-bg)] rounded-lg">ğŸ’ æ°´æ™¶ (Crystal)</button>
                        <button onclick="changeTheme('dawn')" class="w-full text-left px-3 py-2 text-xs text-sub hover:text-main hover:bg-[var(--panel-bg)] rounded-lg">ğŸŒ… æ™¨æ›¦ (Dawn)</button>
                        <div class="h-px bg-[var(--panel-border)] my-1"></div>
                        <div class="px-3 py-1">
                            <label class="text-[10px] text-sub font-bold block mb-1">API Base URL</label>
                            <input type="text" id="custom-base-url" class="w-full bg-[var(--input-bg)] text-xs rounded px-2 py-1 border border-transparent focus:border-[var(--accent-primary)] outline-none" onchange="updateBaseUrl()">
                        </div>
                        <div class="h-px bg-[var(--panel-border)] my-1"></div>
                        <button onclick="exportData()" class="w-full text-left px-3 py-2 text-xs text-sub hover:text-main hover:bg-[var(--panel-bg)] rounded-lg">ğŸ“¤ å¤‡ä»½æ•°æ®</button>
                        <button onclick="performReset()" class="w-full text-left px-3 py-2 text-xs text-red-400 hover:bg-red-500/10 rounded-lg">âš ï¸ é‡ç½®æ‰€æœ‰</button>
                    </div>
                </div>

                <div class="flex items-center bg-[var(--input-bg)] rounded-xl px-2 py-1 border border-[var(--panel-border)]">
                    <input type="password" id="api-key" placeholder="è¾“å…¥ Key (sk-... æˆ– AIza...)" class="bg-transparent border-none text-xs w-32 text-main focus:ring-0 placeholder-opacity-50" oninput="detectEngine()">
                </div>
            </div>
        </div>
    </nav>

    <div id="pet-container">
        <div id="pet-bubble">å¼€å§‹æ„æ€ä¼Ÿå¤§çš„æ•…äº‹å§ï¼</div>
        <div id="pet-body" onclick="petInteract()"></div>
    </div>

    <main id="main-content" class="max-w-[1400px] mx-auto w-full pt-20 px-4 space-y-8 flex-grow pb-20">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 min-h-[500px]">
            <div class="lg:col-span-8 glass-panel p-2 flex flex-col h-[550px] overflow-hidden fade-in">
                <div class="flex gap-2 p-2 bg-[var(--input-bg)] rounded-2xl m-1">
                    <button onclick="switchTab('tab-prompt')" class="flex-1 px-4 py-2 text-sm font-bold rounded-xl transition-all shadow-md bg-[var(--panel-bg)] text-accent" id="btn-tab-prompt">âœ¨ æ•…äº‹æ¢—æ¦‚</button>
                    <button onclick="switchTab('tab-lore')" class="flex-1 px-4 py-2 text-sm font-bold rounded-xl transition-all opacity-60 hover:opacity-100" id="btn-tab-lore">ğŸŒ ä¸–ç•Œè®¾å®š</button>
                </div>
                <div class="p-4 flex-grow flex flex-col">
                    <div id="tab-prompt" class="h-full flex flex-col">
                        <textarea id="novel-prompt" class="glass-input w-full flex-grow rounded-2xl p-4 resize-none mb-4 text-sm leading-relaxed" placeholder="åœ¨æ­¤è¾“å…¥æ•…äº‹æ ¸å¿ƒæ¢—æ¦‚..." oninput="debounceSave()"></textarea>
                        <div class="flex justify-end"><button onclick="generateMoreOutline()" class="btn-gradient font-bold py-3 px-10 rounded-xl shadow-lg hover:scale-105 active:scale-95 transition-transform">ğŸ§  æ„æ€ä¸–ç•Œå¤§çº²</button></div>
                    </div>
                    <div id="tab-lore" class="h-full hidden">
                        <textarea id="novel-lore" class="glass-input w-full h-full rounded-2xl p-4 resize-none text-sm mono-font" placeholder="ã€ä¸–ç•Œè§‚ã€‘åç§°ï¼šæè¿°..." oninput="debounceSave()"></textarea>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-4 glass-panel p-5 flex flex-col h-[550px] fade-in" style="animation-delay: 0.1s;">
                <h2 class="text-base font-bold text-accent mb-4 pb-2 border-b border-[var(--panel-border)]">ğŸ‘¥ è§’è‰²å›¾é‰´</h2>
                <div id="character-list" class="flex-grow overflow-y-auto space-y-3 pr-2 custom-scrollbar">
                    <div class="text-center text-sub text-xs mt-20 opacity-50 italic">æš‚æ— è§’è‰²</div>
                </div>
                <button onclick="aiGenerateCharacter()" class="mt-4 w-full py-2.5 rounded-xl border border-indigo-500/30 text-indigo-300 text-xs font-bold hover:bg-indigo-500/10 transition-colors">âœ¨ AI æäºº</button>
            </div>
        </div>

        <section id="section-outline" class="glass-panel p-6 hidden fade-in">
            <div class="flex justify-between items-center mb-6 pb-4 border-b border-[var(--panel-border)]">
                <h2 class="text-lg font-bold serif-font text-main">ç« èŠ‚èˆªå›¾</h2>
                <div class="flex items-center gap-3">
                    <span id="chapter-progress-text" class="text-xs text-sub font-mono">0/100</span>
                    <input type="number" id="target-total-chapters" value="100" class="w-12 bg-[var(--input-bg)] text-xs text-center rounded border border-[var(--panel-border)] focus:outline-none" onchange="saveData()">
                </div>
            </div>
            <div id="outline-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 max-h-[400px] overflow-y-auto pr-2 custom-scrollbar"></div>
        </section>

        <section id="section-loom" class="hidden fade-in space-y-4">
            <div class="glass-panel p-5 border-l-4 border-l-amber-500 bg-amber-500/5" id="active-outline-module">
                <div class="flex justify-between items-start mb-2">
                    <input type="text" id="active-outline-title" class="bg-transparent border-none text-xl font-bold text-main focus:ring-0 p-0 w-full" placeholder="ç« èŠ‚æ ‡é¢˜" oninput="updateActiveOutlineData()">
                </div>
                <textarea id="active-outline-desc" class="w-full bg-transparent text-sm text-sub resize-none focus:outline-none" rows="2" placeholder="ç« èŠ‚å¤§çº²..." oninput="updateActiveOutlineData()"></textarea>
            </div>

            <div class="glass-panel rounded-3xl h-[70vh] flex flex-col border-t-4 border-[var(--accent-primary)] shadow-2xl">
                <div class="p-4 flex justify-between items-center bg-[var(--input-bg)] border-b border-[var(--panel-border)]">
                    <select id="chapter-selector" class="glass-input rounded-xl px-4 py-2 font-bold w-64 text-sm" onchange="selectChapter(this.value)"><option value="">é€‰æ‹©ç« èŠ‚...</option></select>
                    <div class="flex gap-2">
                        <button onclick="toggleZenMode()" class="btn-ghost px-4 py-2 rounded-xl text-xs">ğŸ§˜ ç¦…æ¨¡å¼</button>
                        <button onclick="generateChapterText(false)" class="btn-accent px-6 py-2 rounded-xl font-bold text-sm">ğŸ–‹ï¸ èµ·ç¬”</button>
                        <button onclick="generateChapterText(true)" class="bg-emerald-600 hover:bg-emerald-500 text-white px-6 py-2 rounded-xl font-bold text-sm">âœ’ï¸ ç»­å†™</button>
                    </div>
                </div>
                <textarea id="chapter-editor" class="flex-grow bg-transparent p-10 md:p-20 resize-none leading-loose text-lg serif-font focus:outline-none text-main" placeholder="åœ¨æ­¤ä¹¦å†™æ­£æ–‡..." oninput="updateWordCount(); debounceSave()"></textarea>
                <div class="px-6 py-2 border-t border-[var(--panel-border)] bg-black/10 flex justify-between text-[10px] text-sub font-mono">
                    <span id="current-word-count">0 Words</span>
                    <span id="save-status">Ready</span>
                </div>
            </div>
        </section>
    </main>

    <div id="disclaimer-modal" class="fixed inset-0 z-[120] hidden bg-black/95 backdrop-blur-xl flex items-center justify-center p-4">
        <div class="glass-panel max-w-2xl w-full p-8 space-y-6">
            <h3 class="text-xl font-bold text-red-400">âš–ï¸ å…è´£å£°æ˜</h3>
            <div class="text-sm text-sub space-y-4 max-h-96 overflow-y-auto pr-2">
                <p>1. æœ¬å·¥å…·ç”Ÿæˆçš„å…¨éƒ¨å†…å®¹ç”± AI æ¨¡å‹ç”Ÿæˆï¼Œå†…å®¹å…·æœ‰è™šæ„æ€§å’Œéšæœºæ€§ã€‚</p>
                <p>2. ç”¨æˆ·åº”éµå®ˆæ³•å¾‹æ³•è§„ï¼Œä¸å¾—ç”Ÿæˆè¿è§„å†…å®¹ã€‚å› ä½¿ç”¨ä¸å½“äº§ç”Ÿçš„åæœç”±ç”¨æˆ·æ‰¿æ‹…ã€‚</p>
                <p>3. <b>æ•°æ®å®‰å…¨</b>ï¼šæ‰€æœ‰å°è¯´æ•°æ®ã€API Key å‡ä¿å­˜åœ¨æµè§ˆå™¨æœ¬åœ° (IndexedDB)ï¼Œä¸ä¼šä¸Šä¼ åˆ°ä»»ä½•ç¬¬ä¸‰æ–¹æœåŠ¡å™¨ã€‚</p>
            </div>
            <button onclick="acceptDisclaimer()" class="w-full btn-accent py-3 rounded-full font-bold shadow-xl">æˆ‘å·²é˜…è¯»å¹¶åŒæ„</button>
        </div>
    </div>

    <script>
        // --- å­˜å‚¨é…ç½® ---
        const DB_CONFIG = { name: 'NebulaQuillDB', version: 1, storeName: 'novel_data' };
        let store = { 
            apiKey: '', 
            concept: '', 
            lore: '', 
            targetChapters: 100, 
            characters: [], 
            outline: [], 
            currentChapterId: null, 
            chapterTexts: {}, 
            theme: 'nebula', 
            engine: 'none',
            model: 'deepseek-chat',
            baseUrl: 'https://api.deepseek.com/chat/completions'
        };

        const idb = {
            db: null,
            async init() {
                return new Promise((resolve) => {
                    const req = indexedDB.open(DB_CONFIG.name, DB_CONFIG.version);
                    req.onupgradeneeded = (e) => { e.target.result.createObjectStore(DB_CONFIG.storeName); };
                    req.onsuccess = (e) => { this.db = e.target.result; resolve(); };
                });
            },
            async put(k, v) { const tx = this.db.transaction(DB_CONFIG.storeName, 'readwrite'); tx.objectStore(DB_CONFIG.storeName).put(v, k); },
            async get(k) { return new Promise(r => { const tx = this.db.transaction(DB_CONFIG.storeName, 'readonly'); const req = tx.objectStore(DB_CONFIG.storeName).get(k); req.onsuccess = () => r(req.result); }); }
        };

        // --- æ ¸å¿ƒé€»è¾‘ ---
        window.onload = async () => {
            await idb.init();
            const saved = await idb.get('quill_data');
            if(saved) {
                store = {...store, ...saved};
                document.getElementById('api-key').value = store.apiKey || '';
                document.getElementById('novel-prompt').value = store.concept || '';
                document.getElementById('novel-lore').value = store.lore || '';
                document.getElementById('target-total-chapters').value = store.targetChapters || 100;
                renderCharacters();
                renderOutline();
                detectEngine();
            }
            if(!localStorage.getItem('quill_agreed')) document.getElementById('disclaimer-modal').classList.remove('hidden');
            resizeCanvas(); initP(); animP();
        };

        function detectEngine() {
            const k = document.getElementById('api-key').value.trim();
            const d = document.getElementById('engine-dot');
            const n = document.getElementById('engine-name');
            if(!d || !n) return;

            if(k.startsWith('sk-')) {
                store.engine = 'deepseek';
                store.model = 'deepseek-chat';
                store.baseUrl = 'https://api.deepseek.com/chat/completions';
                d.className = "w-2 h-2 rounded-full bg-blue-500 shadow-[0_0_5px_rgba(59,130,246,0.8)]";
                n.innerText = "DeepSeek";
                n.className = "text-blue-300 font-bold";
            } else if(k.startsWith('AIza')) {
                store.engine = 'gemini';
                store.model = 'gemini-1.5-flash';
                store.baseUrl = 'https://generativelanguage.googleapis.com/v1beta/openai/chat/completions';
                d.className = "w-2 h-2 rounded-full bg-orange-500 shadow-[0_0_5px_rgba(249,115,22,0.8)]";
                n.innerText = "Gemini";
                n.className = "text-orange-300 font-bold";
            } else {
                store.engine = 'none';
                d.className = "w-2 h-2 rounded-full bg-gray-500";
                n.innerText = "No Key";
                n.className = "opacity-50";
            }
            const urlInput = document.getElementById('custom-base-url');
            if(urlInput) urlInput.value = store.baseUrl;
            debounceSave();
        }

        async function callAI(msgs, onChunk) {
            const k = document.getElementById('api-key').value.trim();
            if(!k) throw new Error("è¯·å…ˆè¾“å…¥ API Key");
            
            const baseUrl = store.baseUrl || "https://api.deepseek.com/chat/completions";
            const model = store.model || "deepseek-chat";

            const r = await fetch(baseUrl, {
                method: "POST",
                headers: { "Content-Type": "application/json", "Authorization": `Bearer ${k}` },
                body: JSON.stringify({ model: model, messages: msgs, temperature: 1.0, stream: !!onChunk })
            });

            if(!r.ok) throw new Error("API è°ƒç”¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥ Key æˆ–ç½‘ç»œ");

            if(onChunk) {
                const reader = r.body.getReader(); const decoder = new TextDecoder();
                while(true) {
                    const {done, value} = await reader.read(); if(done) break;
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    for(const line of lines) {
                        if(line.startsWith('data: ')) {
                            const dataStr = line.slice(6); if(dataStr === '[DONE]') break;
                            try { const json = JSON.parse(dataStr); const content = json.choices[0].delta.content || ""; onChunk(content); } catch(e){}
                        }
                    }
                }
            } else {
                const data = await r.json(); return data.choices[0].message.content;
            }
        }

        // --- åŠŸèƒ½å‡½æ•° ---
        async function aiGenerateCharacter() {
            const prompt = document.getElementById('novel-prompt').value;
            if(!prompt) return showToast("è¯·å…ˆè¾“å…¥æ¢—æ¦‚", "error");
            showToast("AI æ­£åœ¨æ„æ€è§’è‰²...", "info");
            try {
                const res = await callAI([{role:"user", content:`åŸºäºæ¢—æ¦‚ï¼š${prompt}\næ„æ€ä¸€ä¸ªæ–°è§’è‰²ï¼Œè¿”å› JSON: {"name":"","role":"","desc":""}`}]);
                const char = JSON.parse(res.match(/{.*}/s)[0]);
                store.characters.push(char); renderCharacters(); saveData();
            } catch(e) { showToast(e.message, "error"); }
        }

        async function generateMoreOutline() {
            const prompt = document.getElementById('novel-prompt').value;
            if(!prompt) return showToast("è¯·å…ˆè¾“å…¥æ¢—æ¦‚", "error");
            showToast("AI æ­£åœ¨æ¨æ¼”å‰§æƒ…...", "info");
            try {
                const res = await callAI([{role:"user", content:`åŸºäºæ¢—æ¦‚ï¼š${prompt}\nç”Ÿæˆå‰5ç« å¤§çº²ï¼Œè¿”å› JSON æ•°ç»„: [{"title":"","desc":""}]`}]);
                const list = JSON.parse(res.match(/\[.*\]/s)[0]);
                list.forEach((it, i) => store.outline.push({ id: Date.now()+i, ...it }));
                renderOutline(); document.getElementById('section-outline').classList.remove('hidden'); saveData();
            } catch(e) { showToast(e.message, "error"); }
        }

        async function generateChapterText(isCont) {
            const id = store.currentChapterId; if(!id) return showToast("è¯·å…ˆé€‰æ‹©ç« èŠ‚", "error");
            const editor = document.getElementById('chapter-editor');
            const ch = store.outline.find(x => x.id == id);
            const msgs = [
                { role: "system", content: `ä½ æ˜¯ä¸€ä¸ªç½‘ç»œæ–‡å­¦ä½œå®¶ã€‚ä¸–ç•ŒèƒŒæ™¯ï¼š${store.lore}` },
                { role: "user", content: `æœ¬ç« å¤§çº²ï¼š${ch.desc}ã€‚${isCont ? "æ ¹æ®ä¸Šæ–‡ç»­å†™ï¼š" + editor.value.slice(-1000) : "ä»å¤´å¼€å§‹æå†™è¿™ä¸€ç« èŠ‚ï¼š"}` }
            ];
            showToast("AI å¼€å§‹åˆ›ä½œ...", "success");
            try { await callAI(msgs, (c) => { editor.value += c; updateWordCount(); }); store.chapterTexts[id] = editor.value; saveData(); } catch(e) { showToast(e.message, "error"); }
        }

        // --- UI åŒæ­¥ ---
        function renderCharacters() {
            const list = document.getElementById('character-list');
            list.innerHTML = store.characters.map((c, i) => `
                <div class="glass-panel p-3 relative group hover:bg-white/5">
                    <div class="font-bold text-accent text-sm">${c.name} <span class="text-[10px] text-sub font-normal opacity-60">Â· ${c.role}</span></div>
                    <div class="text-[10px] text-sub line-clamp-2 mt-1">${c.desc}</div>
                    <button onclick="store.characters.splice(${i},1);renderCharacters();saveData()" class="absolute top-1 right-2 opacity-0 group-hover:opacity-100 text-red-400">Ã—</button>
                </div>
            `).join('');
        }

        function renderOutline() {
            const container = document.getElementById('outline-container');
            container.innerHTML = store.outline.map((ch, i) => `
                <div class="glass-panel p-4 cursor-pointer hover:border-accent transition ${store.currentChapterId == ch.id ? 'border-accent bg-accent/5' : ''}" onclick="selectChapter(${ch.id})">
                    <div class="text-[10px] text-sub mb-1">ç¬¬ ${i+1} ç« </div>
                    <div class="text-xs font-bold text-main truncate">${ch.title}</div>
                </div>
            `).join('');
            const sel = document.getElementById('chapter-selector');
            sel.innerHTML = '<option value="">é€‰æ‹©ç« èŠ‚...</option>' + store.outline.map(ch => `<option value="${ch.id}">${ch.title}</option>`).join('');
            if(store.currentChapterId) sel.value = store.currentChapterId;
        }

        function selectChapter(id) {
            store.currentChapterId = id;
            const ch = store.outline.find(x => x.id == id);
            document.getElementById('section-loom').classList.remove('hidden');
            document.getElementById('active-outline-title').value = ch.title;
            document.getElementById('active-outline-desc').value = ch.desc;
            document.getElementById('chapter-editor').value = store.chapterTexts[id] || '';
            renderOutline(); updateWordCount();
        }

        function updateWordCount() { document.getElementById('current-word-count').innerText = document.getElementById('chapter-editor').value.length + " Words"; }

        async function saveData() {
            store.apiKey = document.getElementById('api-key').value;
            store.concept = document.getElementById('novel-prompt').value;
            store.lore = document.getElementById('novel-lore').value;
            store.targetChapters = document.getElementById('target-total-chapters').value;
            await idb.put('quill_data', store);
            document.getElementById('save-status').innerText = "Saved " + new Date().toLocaleTimeString();
        }

        let saveTimeout; function debounceSave() { clearTimeout(saveTimeout); saveTimeout = setTimeout(saveData, 1000); }
        function switchTab(id) { ['tab-prompt', 'tab-lore'].forEach(t => document.getElementById(t).classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); }
        function showToast(m, t) { Toastify({ text: m, style: { background: t==='error'?"#f43f5e":"#818cf8" } }).showToast(); }
        function toggleZenMode() { document.body.classList.toggle('zen-mode'); document.getElementById('zen-exit-btn').classList.toggle('hidden'); }
        function acceptDisclaimer() { localStorage.setItem('quill_agreed', 'true'); document.getElementById('disclaimer-modal').classList.add('hidden'); }
        function toggleThemeMenu() { document.getElementById('theme-menu').classList.toggle('hidden'); }
        function changeTheme(t) { document.documentElement.setAttribute('data-theme', t); store.theme = t; saveData(); toggleThemeMenu(); }
        function performReset() { if(confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿ")) { indexedDB.deleteDatabase(DB_CONFIG.name); location.reload(); } }

        // --- è£…é¥°æ€§èƒŒæ™¯ç²’å­ ---
        class Particle { constructor(w,h){this.x=Math.random()*w;this.y=Math.random()*h;this.vx=(Math.random()-0.5)*0.2;this.vy=(Math.random()-0.5)*0.2;this.s=Math.random()*2;this.o=Math.random()*0.5;}update(w,h){this.x+=this.vx;this.y+=this.vy;if(this.x<0)this.x=w;if(this.x>w)this.x=0;if(this.y<0)this.y=h;if(this.y>h)this.y=0;}draw(ctx){ctx.beginPath();ctx.arc(this.x,this.y,this.s,0,Math.PI*2);ctx.fillStyle=`rgba(255,255,255,${this.o})`;ctx.fill();}}
        let ps = [], cw, ch; function resizeCanvas(){const c=document.getElementById('bg-canvas');cw=c.width=window.innerWidth;ch=c.height=window.innerHeight;}
        function initP(){ps=[];for(let i=0;i<50;i++)ps.push(new Particle(cw,ch));}
        function animP(){const c=document.getElementById('bg-canvas');const ctx=c.getContext('2d');ctx.clearRect(0,0,cw,ch);ps.forEach(p=>{p.update(cw,ch);p.draw(ctx);});requestAnimationFrame(animP);}
        function petInteract() { const b = document.getElementById('pet-bubble'); b.classList.add('show'); setTimeout(()=>b.classList.remove('show'), 2000); }
    </script>
</body>
</html>
