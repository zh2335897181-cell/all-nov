<!DOCTYPE html>
<html lang="zh-CN" data-theme="nebula">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#0f172a">
    <meta name="description" content="Nebula Quill: A local-first AI writing IDE.">
    <title>æ˜Ÿäº‘ç¬”å°– v3.8 (è‡ªé€‚åº”ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600;700&family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <!-- å›¾æ ‡åº“ -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%236366f1;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%23a855f7;stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Ccircle cx='50' cy='50' r='48' fill='%231e293b' stroke='url(%23grad)' stroke-width='3'/%3E%3Cpath d='M50 20 L72 55 Q80 70 50 85 Q20 70 28 55 Z' fill='url(%23grad)'/%3E%3C/svg%3E">

    <style>
        /* --- æ ¸å¿ƒä¸»é¢˜ç³»ç»Ÿ --- */
        :root {
            --bg-color: #0b0e14; --text-main: #e2e8f0; --text-sub: #94a3b8;
            --panel-bg: rgba(30, 41, 59, 0.4); --panel-border: rgba(255, 255, 255, 0.06);
            --accent-primary: #818cf8; --accent-secondary: #c084fc; --accent-glow: rgba(129, 140, 248, 0.5);
            --input-bg: rgba(0, 0, 0, 0.2); --scrollbar-thumb: rgba(255, 255, 255, 0.1);
            --nav-height: 64px; /* å®šä¹‰å¯¼èˆªæ é«˜åº¦å˜é‡ */
        }

        [data-theme='nebula'] { --bg-image: radial-gradient(circle at 10% 20%, rgba(49,46,129,0.4), transparent 40%), radial-gradient(circle at 90% 80%, rgba(88,28,135,0.3), transparent 40%), linear-gradient(to bottom, #0f172a, #020617); --panel-bg: rgba(15,23,42,0.6); --accent-primary: #818cf8; --accent-secondary: #6366f1; }
        [data-theme='crystal'] { --bg-color: #081b29; --bg-image: radial-gradient(circle at 50% 0%, rgba(34,211,238,0.15), transparent 50%), linear-gradient(135deg, #0f172a 0%, #111827 100%); --panel-bg: rgba(255,255,255,0.03); --panel-border: rgba(255,255,255,0.12); --accent-primary: #22d3ee; --accent-secondary: #06b6d4; --text-main: #f0f9ff; }
        [data-theme='dawn'] { --bg-color: #fff1f2; --bg-image: linear-gradient(120deg, #fff1f2 0%, #ffe4e6 100%); --text-main: #334155; --text-sub: #64748b; --panel-bg: rgba(255,255,255,0.65); --panel-border: rgba(244,114,182,0.2); --accent-primary: #db2777; --accent-secondary: #be185d; --input-bg: rgba(255,255,255,0.5); --scrollbar-thumb: rgba(0,0,0,0.1); }
        [data-theme='cyber'] { --bg-color: #000000; --bg-image: linear-gradient(90deg, rgba(20,20,20,0.5) 1px, transparent 1px), linear-gradient(rgba(20,20,20,0.5) 1px, transparent 1px); background-size: 40px 40px; --panel-bg: rgba(10,10,10,0.9); --panel-border: #333; --accent-primary: #2dd4bf; --accent-secondary: #0d9488; --input-bg: #000; }
        [data-theme='ink'] { --bg-color: #f5f5f4; --bg-image: radial-gradient(#e7e5e4 1px, transparent 1px); background-size: 20px 20px; --text-main: #1c1917; --text-sub: #57534e; --panel-bg: rgba(255,255,255,0.85); --panel-border: rgba(0,0,0,0.08); --accent-primary: #44403c; --accent-secondary: #292524; --input-bg: #fff; --scrollbar-thumb: rgba(0,0,0,0.15); }

        body { font-family: 'Inter', sans-serif; background-color: var(--bg-color); background-image: var(--bg-image); background-attachment: fixed; color: var(--text-main); transition: all 0.5s ease; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
        #bg-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; }
        .serif-font { font-family: 'Noto Serif SC', serif; } .mono-font { font-family: 'JetBrains Mono', monospace; }

        .glass-panel { background: var(--panel-bg); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px); border: 1px solid var(--panel-border); box-shadow: 0 8px 32px -8px rgba(0,0,0,0.15); border-radius: 1.5rem; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .glass-input { background: var(--input-bg); border: 1px solid transparent; color: var(--text-main); transition: all 0.2s; width: 100%; }
        .glass-input:focus { outline: none; border-color: var(--accent-primary); box-shadow: 0 0 0 1px var(--accent-primary); background: var(--panel-bg); }
        .btn-gradient { background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); color: white; transition: all 0.3s; }
        .btn-gradient:hover { transform: translateY(-1px); box-shadow: 0 8px 20px rgba(0,0,0,0.2); filter: brightness(1.1); }
        .btn-ghost { background: transparent; border: 1px solid var(--panel-border); color: var(--text-sub); transition: all 0.2s; }
        .btn-ghost:hover { border-color: var(--accent-primary); color: var(--text-main); background: var(--panel-bg); }
        .btn-accent { background: var(--accent-primary); color: white; transition: all 0.2s; }
        .btn-accent:hover { filter: brightness(1.1); transform: translateY(-1px); }

        .text-accent { color: var(--accent-primary) !important; }
        .card-active { border-color: var(--accent-primary); background: linear-gradient(135deg, var(--panel-bg), rgba(var(--accent-primary), 0.1)); box-shadow: 0 0 20px rgba(var(--accent-primary), 0.2); }
        .blur-content { filter: blur(8px); pointer-events: none; user-select: none; }
        .fade-in { animation: fadeIn 0.5s ease-out; } @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .dropdown-enter { animation: dropIn 0.2s ease-out forwards; } @keyframes dropIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        /* Chips Style */
        .lore-chip { display: inline-flex; align-items: center; gap: 6px; padding: 5px 10px; background: rgba(0,0,0,0.2); border: 1px solid var(--panel-border); border-radius: 8px; cursor: pointer; transition: all 0.2s; color: var(--text-sub); font-size: 0.75rem; white-space: nowrap; user-select: none; }
        .lore-chip:hover { background: var(--panel-bg); border-color: var(--accent-primary); color: var(--text-main); }
        .lore-chip-icon { color: var(--accent-primary); font-size: 0.9em; }

        .novel-tag { background: rgba(var(--accent-primary), 0.1); border: 1px solid var(--panel-border); color: var(--text-main); font-size: 0.75rem; padding: 3px 10px; border-radius: 99px; display: inline-flex; align-items: center; gap: 6px; cursor: default; }
        .tag-remove:hover { color: #f43f5e; cursor: pointer; }
        .tag-selectable { background: var(--input-bg); border: 1px solid transparent; padding: 5px 12px; border-radius: 8px; font-size: 0.8rem; cursor: pointer; transition: all 0.2s; color: var(--text-sub); }
        .tag-selectable.selected { background-color: var(--accent-primary); color: white; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        
        .announcement-important { border-left: 4px solid #f59e0b; background: linear-gradient(90deg, rgba(245, 158, 11, 0.15), transparent); }
        .tutorial-body ul { list-style: disc; padding-left: 1.2rem; margin-bottom: 1rem; color: var(--text-sub); }
        .tutorial-body li { margin-bottom: 0.5rem; }
        .tutorial-body h4 { font-weight: bold; color: var(--text-main); margin-top: 1.5rem; margin-bottom: 0.8rem; display: flex; align-items: center; gap: 8px; }
        .tutorial-body code { background: rgba(0,0,0,0.3); padding: 2px 5px; border-radius: 4px; font-family: monospace; color: var(--accent-primary); }

        ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-track { background: transparent; } ::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 99px; } ::-webkit-scrollbar-thumb:hover { background: var(--accent-primary); }
        
        /* --- Zen Mode (ç¦…æ¨¡å¼) Optimized for Mobile --- */
        body.zen-mode #bg-canvas, body.zen-mode nav, body.zen-mode #main-content > div:not(#section-loom), body.zen-mode footer, body.zen-mode #pet-container, body.zen-mode #theme-menu, body.zen-mode #section-outline { display: none !important; }
        body.zen-mode #section-loom { display: block; position: fixed; inset: 0; z-index: 50; padding: 0; margin: 0; background: var(--bg-color); height: 100dvh; }
        body.zen-mode #loom-panel { height: 100dvh; border: none; border-radius: 0; background: transparent; box-shadow: none; }
        body.zen-mode #loom-header { opacity: 0; transition: opacity 0.3s; }
        body.zen-mode #loom-header:hover { opacity: 1; }
        /* æ‰‹æœºç«¯ç¦…æ¨¡å¼å¤´éƒ¨ä¸€ç›´æ˜¾ç¤ºï¼Œé¿å…æ‰¾ä¸åˆ°æŒ‰é’® */
        @media (max-width: 768px) {
            body.zen-mode #loom-header { opacity: 1 !important; padding: 10px; }
            body.zen-mode #chapter-editor { padding-top: 10px; font-size: 1.1rem; }
        }
        body.zen-mode #chapter-editor { font-size: 1.25rem; line-height: 2; max-width: 900px; margin: 0 auto; padding-top: 5vh; height: calc(100% - 20px); }
        #zen-exit-btn { display: none; }
        body.zen-mode #zen-exit-btn { display: block; position: fixed; top: 20px; right: 20px; z-index: 60; opacity: 0.3; transition: opacity 0.3s; }
        body.zen-mode #zen-exit-btn:hover { opacity: 1; }

        /* --- AI Toolbar (åˆ’è¯å·¥å…·æ ) --- */
        #ai-toolbar { position: fixed; z-index: 1000; background: var(--panel-bg); backdrop-filter: blur(16px); border: 1px solid var(--panel-border); border-radius: 12px; padding: 4px; display: flex; gap: 4px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.3); transform: translateY(10px); opacity: 0; pointer-events: none; transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1); }
        #ai-toolbar.visible { transform: translateY(0); opacity: 1; pointer-events: auto; }
        /* æ‰‹æœºç«¯å·¥å…·æ é€‚é… */
        @media (max-width: 640px) {
            #ai-toolbar { width: 90%; left: 5% !important; top: auto !important; bottom: 20px; justify-content: space-around; }
        }
        .ai-tool-btn { padding: 6px 10px; border-radius: 8px; font-size: 0.75rem; color: var(--text-main); background: transparent; transition: background 0.2s; display: flex; align-items: center; gap: 4px; white-space: nowrap; }
        .ai-tool-btn:hover { background: rgba(255,255,255,0.1); }
        
        /* --- Graph Visual (å…³ç³»å›¾) --- */
        #graph-canvas, #lore-canvas { width: 100%; height: 100%; border-radius: 1rem; cursor: grab; touch-action: none; }
        #graph-canvas:active, #lore-canvas:active { cursor: grabbing; }

        /* Lore specific grid bg */
        .grid-bg { background-image: linear-gradient(var(--panel-border) 1px, transparent 1px), linear-gradient(90deg, var(--panel-border) 1px, transparent 1px); background-size: 20px 20px; background-position: center center; }

        /* --- Pet (æ¡Œå® ) --- */
        #pet-container { position: fixed; bottom: 20px; right: 20px; width: 100px; height: 100px; z-index: 999; pointer-events: none; }
        /* æ‰‹æœºç«¯é»˜è®¤éšè—æ¡Œå® ä»¥é˜²é®æŒ¡ï¼Œæˆ–ä½¿å…¶æ›´å° */
        @media (max-width: 768px) {
            #pet-container { display: none; } 
        }
        #pet-body { width: 60px; height: 60px; background: radial-gradient(circle at 30% 30%, var(--accent-primary), var(--accent-secondary)); border-radius: 50%; position: absolute; bottom: 10px; right: 10px; box-shadow: 0 0 20px var(--accent-primary), inset -5px -5px 10px rgba(0,0,0,0.2); pointer-events: auto; cursor: pointer; transition: transform 0.2s; animation: pet-float 3s ease-in-out infinite; -webkit-tap-highlight-color: transparent; }
        #pet-body::after { content: ''; position: absolute; top: -10%; left: -10%; right: -10%; bottom: -10%; border-radius: 50%; background: var(--accent-primary); opacity: 0.3; filter: blur(10px); z-index: -1; }
        .pet-eyes { position: absolute; top: 35%; left: 50%; transform: translateX(-50%); display: flex; gap: 8px; }
        .pet-eye { width: 8px; height: 8px; background: #fff; border-radius: 50%; position: relative; animation: pet-blink 4s infinite; }
        .pet-eye::after { content: ''; position: absolute; width: 4px; height: 4px; background: #000; border-radius: 50%; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        #pet-bubble { position: absolute; bottom: 80px; right: 0; background: var(--panel-bg); border: 1px solid var(--panel-border); color: var(--text-main); font-size: 0.75rem; padding: 8px 12px; border-radius: 12px 12px 0 12px; width: 160px; opacity: 0; transform: scale(0.8); transform-origin: bottom right; transition: all 0.3s; backdrop-filter: blur(12px); pointer-events: none; }
        #pet-bubble.show { opacity: 1; transform: scale(1); }
        @keyframes pet-float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }
        @keyframes pet-blink { 0%, 96%, 100% { height: 8px; transform: scaleY(1); } 98% { height: 1px; transform: scaleY(0.1); } }
        .pet-happy { animation: pet-jump 0.5s infinite !important; }
        @keyframes pet-jump { 0%, 100% { transform: translateY(0) scale(1,1); } 50% { transform: translateY(-15px) scale(0.9, 1.1); } }
        
        /* --- Critique Modal Specifics (æ¯’èˆŒå®¡ç¨¿) --- */
        #critique-content { white-space: pre-wrap; font-family: 'JetBrains Mono', monospace; line-height: 1.6; }
        .critique-highlight { color: #fca5a5; font-weight: bold; border-bottom: 1px dashed #fca5a5; }
    </style>
</head>
<body class="min-h-screen flex flex-col selection:bg-indigo-500/30">

    <canvas id="bg-canvas"></canvas>
    
    <!-- Zen Mode Exit Button -->
    <button id="zen-exit-btn" onclick="toggleZenMode()" class="btn-ghost px-4 py-2 rounded-full border border-red-500/30 text-red-400 font-bold backdrop-blur-md">âœ• é€€å‡ºç¦…æ¨¡å¼</button>

    <!-- AI Polish Toolbar -->
    <div id="ai-toolbar">
        <button onclick="aiAssist('polish')" class="ai-tool-btn">âœ¨ æ¶¦è‰²</button>
        <button onclick="aiAssist('expand')" class="ai-tool-btn">ğŸ” æ‰©å†™</button>
        <button onclick="aiAssist('shorten')" class="ai-tool-btn">âœ‚ï¸ ç²¾ç®€</button>
        <div class="w-px h-4 bg-white/10 mx-1"></div>
        <button onclick="aiAssist('synonym')" class="ai-tool-btn">ğŸ”„ æ¢è¯</button>
    </div>

    <!-- Navigation Bar: Optimized height (h-16) and padding for mobile -->
    <nav class="w-full h-16 fixed top-0 z-[100] glass-panel border-t-0 border-x-0 border-b border-[var(--panel-border)] flex items-center shadow-sm backdrop-blur-md !rounded-none">
        <div class="max-w-[1400px] mx-auto w-full px-4 md:px-6 flex justify-between items-center h-full">
            <div class="flex items-center gap-3 select-none shrink-0">
                <div class="w-9 h-9 md:w-10 md:h-10 rounded-xl bg-gradient-to-br from-[var(--accent-primary)] to-[var(--accent-secondary)] flex items-center justify-center text-white shadow-lg text-lg md:text-xl">âœ’ï¸</div>
                <div class="block"><h1 class="text-base md:text-lg font-bold tracking-widest serif-font text-accent leading-none">æ˜Ÿäº‘ç¬”å°–</h1><span class="hidden sm:block text-[10px] text-sub tracking-widest opacity-60 uppercase">Nebula Quill v3.8</span></div>
            </div>
            
            <div class="flex items-center gap-2 md:gap-3">
                <div class="hidden xl:flex items-center gap-3 px-4 py-1.5 rounded-full border border-[var(--panel-border)] bg-[var(--input-bg)]"><span id="live-clock" class="text-xs text-sub mono-font border-r border-[var(--panel-border)] pr-3">00:00</span><span id="save-status" class="text-xs text-sub">Ready</span></div>
                
                <div class="relative cursor-pointer p-2 hover:bg-[var(--panel-border)] rounded-xl transition opacity-70 hover:opacity-100" onclick="toggleAnnouncements()">
                    <span class="text-lg">ğŸ””</span>
                    <span id="notification-dot" class="absolute top-2 right-2 w-2 h-2 bg-red-500 rounded-full hidden animate-bounce shadow-sm"></span>
                </div>

                <button onclick="toggleTutorial()" class="p-2 rounded-xl hover:bg-[var(--panel-border)] transition text-lg opacity-70 hover:opacity-100 hidden sm:block" title="èˆªè¡ŒæŒ‡å—">ğŸ“˜</button>

                <div id="engine-status" class="hidden lg:flex items-center gap-2 px-3 py-1.5 rounded-lg border border-[var(--panel-border)] bg-[var(--input-bg)]"><span class="w-2 h-2 rounded-full bg-gray-500 transition-colors" id="engine-dot"></span><span id="engine-name" class="text-xs font-mono text-sub">No Key</span></div>
                
                <div class="relative shrink-0">
                    <button onclick="toggleThemeMenu()" id="theme-btn" class="p-2 rounded-xl hover:bg-[var(--panel-border)] transition text-lg opacity-70 hover:opacity-100" title="è®¾ç½® & ä¸»é¢˜">âš™ï¸</button>
                    <div id="theme-menu" class="absolute right-0 mt-4 w-48 glass-panel rounded-xl overflow-hidden hidden shadow-2xl z-[101] border border-[var(--panel-border)] p-1">
                        <div class="px-3 py-2 text-[10px] text-sub font-bold uppercase tracking-wider opacity-60">Theme</div>
                        <button onclick="changeTheme('nebula')" class="w-full text-left px-3 py-2 text-xs text-sub hover:text-main hover:bg-[var(--panel-bg)] rounded-lg flex items-center gap-2">ğŸŒŒ æ˜Ÿæ²³ (Nebula)</button>
                        <button onclick="changeTheme('crystal')" class="w-full text-left px-3 py-2 text-xs text-sub hover:text-main hover:bg-[var(--panel-bg)] rounded-lg flex items-center gap-2">ğŸ’ æ°´æ™¶ (Crystal)</button>
                        <button onclick="changeTheme('dawn')" class="w-full text-left px-3 py-2 text-xs text-sub hover:text-main hover:bg-[var(--panel-bg)] rounded-lg flex items-center gap-2">ğŸŒ… æ™¨æ›¦ (Dawn)</button>
                        <div class="h-px bg-[var(--panel-border)] my-1"></div>
                        <div class="px-3 py-2 text-[10px] text-sub font-bold uppercase tracking-wider opacity-60">Data</div>
                        <button onclick="exportData()" class="w-full text-left px-3 py-2 text-xs text-sub hover:text-main hover:bg-[var(--panel-bg)] rounded-lg flex items-center gap-2">ğŸ“¤ å¤‡ä»½æ•°æ®</button>
                        <button onclick="document.getElementById('file-upload').click()" class="w-full text-left px-3 py-2 text-xs text-sub hover:text-main hover:bg-[var(--panel-bg)] rounded-lg flex items-center gap-2">ğŸ“¥ æ¢å¤æ•°æ®</button>
                        <div class="px-3 py-1 mt-2">
                             <label class="text-[10px] text-sub font-bold uppercase tracking-wider opacity-60 block mb-1">Base URL</label>
                            <input type="text" id="custom-base-url" placeholder="API Base URL" class="w-full bg-[var(--input-bg)] text-xs rounded px-2 py-1 text-sub border border-transparent focus:border-[var(--accent-primary)] outline-none" onchange="updateBaseUrl()">
                        </div>
                         <div class="px-3 py-1 mb-2">
                            <label class="text-[10px] text-sub font-bold uppercase tracking-wider opacity-60 block mb-1">ç« èŠ‚å­—æ•°</label>
                            <input type="text" id="setting-default-words" placeholder="ä¾‹å¦‚: 2000-3000" class="w-full bg-[var(--input-bg)] text-xs rounded px-2 py-1.5 text-sub border border-transparent focus:border-[var(--accent-primary)] outline-none" onchange="updateDefaultWords()">
                        </div>
                        <input type="file" id="file-upload" class="hidden" accept=".json" onchange="importData(this)">
                    </div>
                </div>

                <button onclick="togglePet()" id="pet-btn" class="p-2 rounded-xl hover:bg-[var(--panel-border)] transition text-lg opacity-70 hover:opacity-100 text-accent hidden md:block" title="æ¡Œå® ">ğŸ‘¾</button>
                <div class="flex items-center bg-[var(--input-bg)] rounded-xl px-1 py-1 border border-[var(--panel-border)] ml-1 md:ml-2">
                    <div class="w-7 h-7 md:w-8 md:h-8 flex items-center justify-center rounded-lg bg-[var(--panel-bg)] mr-1 md:mr-2 text-sm md:text-base" id="engine-icon">ğŸ”‘</div>
                    <input type="password" id="api-key" placeholder="API Key" class="bg-transparent border-none text-xs w-16 md:w-24 text-main focus:ring-0 placeholder-opacity-50" oninput="detectEngine()">
                </div>
            </div>
        </div>
    </nav>

    <div id="pet-container">
        <div id="pet-bubble">ä¸»äººï¼Œè¯¥ç å­—å•¦~ ğŸ“</div>
        <div id="pet-body" onclick="petInteract()">
            <div class="pet-eyes">
                <div class="pet-eye" id="eye-l"></div>
                <div class="pet-eye" id="eye-r"></div>
            </div>
        </div>
    </div>

    <!-- Main Content: Mobile padding adjustment (px-3) -->
    <main id="main-content" class="max-w-[1400px] mx-auto w-full pt-20 md:pt-24 px-3 md:px-6 space-y-6 md:space-y-8 flex-grow pb-20">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-end pb-2 border-b border-[var(--panel-border)] gap-2">
            <div><h2 class="text-xl md:text-2xl font-bold serif-font text-main">ä¸–ç•Œæ„ç­‘</h2><p class="text-xs text-sub mt-1 opacity-70">â€œç”¨æ˜Ÿå…‰ç¼–ç»‡ä½ çš„å®å¤§ä¸–ç•Œ...â€</p></div>
            <button onclick="downloadNovel()" class="btn-gradient px-4 py-2 rounded-xl text-xs md:text-sm font-bold shadow-lg flex items-center gap-2 w-full md:w-auto justify-center">ğŸ“¥ å¯¼å‡ºå…¨ä¹¦ (TXT)</button>
        </div>

        <!-- Grid Layout: Mobile stacks (h-auto), Desktop fixed height -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-4 md:gap-6 h-auto lg:min-h-[600px]">
            <!-- Prompt/Lore Panel -->
            <div class="lg:col-span-8 glass-panel rounded-3xl p-2 flex flex-col h-[500px] lg:h-full overflow-hidden fade-in" style="animation-delay: 0.1s;">
                <div class="flex gap-1 md:gap-2 p-1.5 md:p-2 mb-1 bg-[var(--input-bg)] rounded-2xl mx-1 md:mx-2 mt-2">
                    <button onclick="switchTab('tab-prompt')" class="flex-1 px-2 md:px-4 py-2 text-xs md:text-sm font-bold rounded-xl transition-all duration-300 shadow-md bg-[var(--panel-bg)] text-accent whitespace-nowrap" id="btn-tab-prompt">âœ¨ æ¢—æ¦‚</button>
                    <button onclick="switchTab('tab-lore')" class="flex-1 px-2 md:px-4 py-2 text-xs md:text-sm font-bold rounded-xl transition-all duration-300 opacity-60 hover:opacity-100 hover:bg-[var(--panel-bg)] whitespace-nowrap" id="btn-tab-lore">ğŸŒ ä¸–ç•Œè§‚</button>
                    <button onclick="switchTab('tab-graph')" class="flex-1 px-2 md:px-4 py-2 text-xs md:text-sm font-bold rounded-xl transition-all duration-300 opacity-60 hover:opacity-100 hover:bg-[var(--panel-bg)] whitespace-nowrap" id="btn-tab-graph">ğŸ•¸ï¸ æ˜Ÿå›¾</button>
                </div>
                <div class="p-3 md:p-4 flex-grow flex flex-col relative h-full overflow-y-auto">
                    <!-- Tab: Prompt -->
                    <div id="tab-prompt" class="h-full flex flex-col w-full">
                        <div class="mb-4 flex flex-wrap gap-2 items-center min-h-[40px] bg-[var(--input-bg)] p-2.5 rounded-xl border border-[var(--panel-border)]">
                            <button onclick="toggleTagSelector()" class="text-xs btn-ghost px-3 py-1.5 rounded-full flex items-center gap-1 border-dashed border border-current opacity-70 hover:opacity-100 transition hover:border-solid hover:bg-[var(--accent-primary)] hover:text-white hover:border-transparent whitespace-nowrap"><span>ğŸ·ï¸ æ ‡ç­¾</span></button>
                            <div id="selected-tags-container" class="flex flex-wrap gap-2"></div>
                        </div>
                        <textarea id="novel-prompt" class="glass-input w-full flex-grow rounded-2xl p-4 md:p-5 resize-none mb-4 text-sm md:text-base leading-relaxed min-h-[200px]" placeholder="åœ¨æ­¤è¾“å…¥æ•…äº‹æ ¸å¿ƒæ¢—æ¦‚...&#10;ä¾‹å¦‚ï¼šèµ›åšæœ‹å…‹èƒŒæ™¯ä¸‹ï¼Œä¸€ä¸ªä¸“é—¨æ›¿æœºå™¨äººå†™é—ä¹¦çš„ä½œå®¶..." oninput="debounceSave()"></textarea>
                        <div class="flex justify-end"><button id="btn-gen-idea" onclick="generateInitialAnalysis()" class="btn-gradient font-bold py-3 px-8 md:px-10 rounded-xl shadow-lg flex items-center gap-2 text-sm transition-transform hover:scale-105 active:scale-95 w-full md:w-auto justify-center"><span>ğŸ§  æ„æ€ä¸–ç•Œæ¶æ„</span></button></div>
                    </div>
                    
                    <!-- Tab: Lore -->
                    <div id="tab-lore" class="h-full flex-col hidden w-full">
                        <div class="flex flex-col gap-3 mb-3">
                            <div class="flex justify-between items-center border-b border-[var(--panel-border)] pb-2 px-1">
                                <div class="flex items-center gap-2">
                                    <div class="w-8 h-8 rounded-lg bg-[var(--input-bg)] flex items-center justify-center text-accent">ğŸ“š</div>
                                    <div><h3 class="font-bold text-sm text-main leading-none">åˆ›ä¸–æ¡£æ¡ˆ</h3></div>
                                </div>
                                <div class="bg-[var(--input-bg)] p-1 rounded-lg flex border border-[var(--panel-border)]">
                                    <button onclick="setLoreView('text')" id="btn-lore-text" class="px-3 py-1 text-xs font-bold rounded-md bg-[var(--panel-bg)] text-accent shadow-sm transition-all">ğŸ“ æè¿°</button>
                                    <button onclick="setLoreView('graph')" id="btn-lore-graph" class="px-3 py-1 text-xs font-bold rounded-md text-sub hover:text-main transition-all">ğŸ•¸ï¸ æ‹“æ‰‘</button>
                                </div>
                            </div>
                            <!-- Chips: scrollable on mobile -->
                            <div class="flex items-center gap-2 overflow-x-auto no-scrollbar pb-1 px-1 w-full">
                                <button class="lore-chip shrink-0" onclick="insertLoreTemplate('ç­‰çº§ä½“ç³»')"><span class="lore-chip-icon">ğŸ“ˆ</span>ç­‰çº§</button>
                                <button class="lore-chip shrink-0" onclick="insertLoreTemplate('åœ°ç†ç¯å¢ƒ')"><span class="lore-chip-icon">ğŸ—ºï¸</span>åœ°å›¾</button>
                                <button class="lore-chip shrink-0" onclick="insertLoreTemplate('åŠ¿åŠ›ç»„ç»‡')"><span class="lore-chip-icon">ğŸ°</span>åŠ¿åŠ›</button>
                                <div class="w-px h-4 bg-[var(--panel-border)] mx-1 shrink-0"></div>
                                <button onclick="aiGenLore()" class="lore-chip !border-[var(--accent-primary)] !text-accent hover:!bg-[var(--accent-primary)] hover:!text-white shadow-sm shrink-0"><span class="lore-chip-icon">âœ¨</span>AI æ¨æ¼”</button>
                            </div>
                        </div>
                        <div class="relative flex-grow overflow-hidden rounded-xl border border-[var(--panel-border)] bg-[var(--input-bg)] group min-h-[300px]">
                            <div id="lore-loading" class="absolute inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex flex-col items-center justify-center rounded-xl"><div class="animate-spin text-3xl mb-2 text-accent">ğŸ”®</div><p class="text-xs text-main animate-pulse">æ­£åœ¨æ¨æ¼”ä¸–ç•Œæ³•åˆ™...</p></div>
                            <div id="lore-text-view" class="w-full h-full absolute inset-0 z-10 p-1">
                                <textarea id="novel-lore" class="w-full h-full bg-transparent p-4 md:p-5 resize-none text-xs md:text-sm mono-font focus:outline-none" style="background-image: linear-gradient(var(--panel-border) 1px, transparent 1px); background-size: 100% 32px; line-height: 32px;" placeholder="ã€åˆ›ä¸–æ¡£æ¡ˆã€‘&#10;æ ¼å¼ï¼š&#10;ã€å¤§æ ‡é¢˜ã€‘&#10;åç§°ï¼šæè¿°" oninput="debounceSave()"></textarea>
                            </div>
                            <div id="lore-graph-view" class="w-full h-full absolute inset-0 z-20 flex flex-col grid-bg hidden bg-[var(--bg-color)]">
                                <div class="absolute top-3 left-3 z-10 bg-[var(--panel-bg)] backdrop-blur px-3 py-1.5 rounded-lg text-xs text-sub border border-[var(--panel-border)] pointer-events-none shadow-sm flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-green-400 animate-pulse"></span><span>Force Layout</span></div>
                                <canvas id="lore-canvas"></canvas>
                                <button onclick="parseLoreToGraph()" class="absolute bottom-3 right-3 btn-ghost text-xs px-3 py-1.5 rounded-lg z-10 bg-[var(--panel-bg)] shadow-sm backdrop-blur border border-[var(--panel-border)] hover:text-accent">ğŸ”„ åˆ·æ–°</button>
                            </div>
                        </div>
                    </div>

                    <!-- Tab: Graph -->
                    <div id="tab-graph" class="h-full flex-col hidden w-full relative min-h-[300px]">
                        <div class="absolute top-2 left-2 z-10 bg-[var(--panel-bg)] px-3 py-1 rounded-lg text-xs text-sub border border-[var(--panel-border)] pointer-events-none">âœ¨ æ‹–åŠ¨æ˜Ÿä½“æ•´ç†å…³ç³»</div>
                        <canvas id="graph-canvas"></canvas>
                        <button onclick="initGraph()" class="absolute bottom-2 right-2 btn-ghost text-xs px-3 py-1 rounded-lg">é‡ç½®è§†å›¾</button>
                    </div>
                </div>
            </div>

            <!-- Character Panel -->
            <div class="lg:col-span-4 glass-panel rounded-3xl p-4 md:p-5 flex flex-col h-[400px] lg:h-full relative fade-in" style="animation-delay: 0.2s;">
                <div class="flex justify-between items-center mb-4 pb-3 border-b border-[var(--panel-border)]">
                    <h2 class="text-base font-bold text-accent serif-font flex items-center gap-2">ğŸ‘¥ äººç‰©å›¾é‰´</h2>
                    <div class="flex gap-2">
                        <button onclick="aiGenerateCharacter(this)" class="px-2 md:px-3 py-1 rounded-lg text-xs font-bold border border-indigo-500/30 text-indigo-300 hover:bg-indigo-500/10 transition-colors flex items-center gap-1 whitespace-nowrap">âœ¨ AI æäºº</button>
                        <button onclick="toggleModal('char-modal')" class="btn-ghost px-2 md:px-3 py-1 rounded-lg text-xs opacity-80 hover:opacity-100 whitespace-nowrap">+ æ‰‹æ“</button>
                    </div>
                </div>
                <div id="character-list" class="flex-grow overflow-y-auto grid grid-cols-1 xl:grid-cols-2 gap-3 pr-2 custom-scrollbar content-start max-h-[600px]">
                    <div class="text-center text-sub text-xs mt-20 opacity-50 italic">æš‚æ— è§’è‰²æ•°æ®<br>è¯·ç‚¹å‡»å·¦ä¾§â€œæ„æ€â€ç”Ÿæˆ</div>
                </div>
            </div>
        </div>

        <!-- Outline Section -->
        <section id="section-outline" class="glass-panel rounded-3xl p-4 md:p-6 hidden fade-in relative transition-all border-l-4 border-l-transparent">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 pb-4 border-b border-[var(--panel-border)] gap-4">
                <div class="flex flex-wrap items-center gap-2 md:gap-4 w-full md:w-auto">
                    <div class="p-2.5 bg-[var(--input-bg)] rounded-xl text-accent text-xl shadow-inner">ğŸ—ºï¸</div>
                    <div><h2 class="text-lg font-bold serif-font text-main">ç« èŠ‚èˆªå›¾</h2><div class="text-xs text-sub mt-0.5 opacity-80">Storyline Roadmap</div></div>
                    <div class="ml-auto md:ml-4 flex items-center gap-2 glass-input px-3 py-1.5 rounded-lg border-0 w-auto"><span class="text-xs text-sub">ç›®æ ‡:</span><input type="number" id="target-total-chapters" value="100" class="bg-transparent w-10 text-center text-xs font-bold focus:outline-none text-main" onchange="updateProgressUI(); saveData()"><span class="text-xs text-sub">ç« </span></div>
                    <span id="chapter-progress-text" class="text-xs text-sub font-mono bg-[var(--input-bg)] px-2 py-0.5 rounded border border-[var(--panel-border)]">0/100</span>
                </div>
                <button onclick="generateMoreOutline()" id="btn-add-outline" class="btn-ghost px-5 py-2.5 rounded-xl text-sm font-bold shadow-sm flex items-center gap-2 hover:bg-[var(--input-bg)] w-full md:w-auto justify-center"><span>+ å»¶å±•å‰§æƒ…</span><div id="outline-spinner" class="hidden w-3 h-3 border-2 border-current border-t-transparent rounded-full animate-spin"></div></button>
            </div>
            <div class="relative min-h-[320px]">
                <div id="outline-empty-state" class="absolute inset-0 flex flex-col items-center justify-center text-sub opacity-30 pointer-events-none"><span class="text-6xl mb-4 grayscale opacity-50">ğŸŒŒ</span><p class="text-xs font-bold uppercase tracking-widest">æ˜Ÿå›¾æœªç»˜ Â· ç­‰å¾…è§‚æµ‹</p></div>
                <div id="outline-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 max-h-[420px] overflow-y-auto pr-2 pb-24 custom-scrollbar"></div>
                <div class="absolute bottom-0 left-0 w-full h-28 bg-gradient-to-t from-[var(--panel-bg)] to-transparent pointer-events-none flex justify-center items-end pb-6 z-10">
                     <button onclick="activateLoom()" class="pointer-events-auto btn-gradient text-white text-lg font-bold py-3.5 px-12 rounded-full shadow-2xl transition transform hover:-translate-y-1 flex items-center gap-3 backdrop-blur-md border border-white/10 group"><span>ğŸš€ è¿›å…¥æ˜Ÿäº‘ç»‡æœº</span><span class="group-hover:translate-x-1 transition-transform">â†’</span></button>
                </div>
            </div>
        </section>

        <!-- Nebula Loom Section: Mobile uses dvh for better keyboard handling -->
        <section id="section-loom" class="hidden fade-in space-y-4">
            <!-- Active Outline Editor Module -->
            <div id="active-outline-module" class="glass-panel p-4 md:p-5 border-l-4 border-l-amber-500 bg-amber-500/5 transition-all relative hidden shadow-[0_0_20px_rgba(245,158,11,0.1)]">
                <div class="flex flex-col md:flex-row justify-between items-start mb-2 gap-3 md:gap-4">
                    <div class="w-full">
                        <h3 class="text-xs font-bold text-amber-400 flex items-center gap-2 uppercase tracking-widest opacity-80">
                            <span>ğŸ“Œ</span> å½“å‰å¤§çº²
                        </h3>
                        <input type="text" id="active-outline-title" class="bg-transparent border-none text-lg md:text-xl font-bold text-main focus:ring-0 p-0 w-full mt-1 placeholder-white/20" placeholder="ç« èŠ‚æ ‡é¢˜" oninput="updateActiveOutlineData()">
                    </div>
                    <div class="flex items-center gap-2 bg-[var(--input-bg)] px-3 py-1.5 rounded-lg border border-amber-500/30 shrink-0 self-end md:self-auto">
                        <span class="text-xs text-amber-300 font-bold">ğŸ¯ å­—æ•°:</span>
                        <input type="text" id="active-outline-words" value="2000-3000" class="bg-transparent border-none text-xs text-amber-200 w-20 text-center focus:ring-0 p-0 font-mono font-bold" onchange="updateActiveOutlineData()">
                    </div>
                </div>
                <textarea id="active-outline-desc" class="w-full bg-[var(--input-bg)] rounded-xl p-3 text-sm text-sub resize-y min-h-[80px] border border-transparent focus:border-amber-500/50 outline-none leading-relaxed" placeholder="ä¿®è®¢æœ¬ç« å¤§çº²ï¼ŒAI å°†éµå¾ªæ­¤è®¾å®š..." oninput="updateActiveOutlineData()"></textarea>
            </div>

            <!-- Loom Panel: Mobile height adaptation (75dvh) to avoid keyboard issues -->
            <div class="glass-panel rounded-3xl p-1.5 h-[75dvh] md:h-[80vh] flex flex-col border-t-4 border-[var(--accent-primary)] shadow-2xl" id="loom-panel">
                <div id="loom-header" class="p-3 md:p-4 rounded-t-2xl flex flex-col md:flex-row justify-between items-center gap-3 bg-[var(--input-bg)] border-b border-[var(--panel-border)]">
                    <div class="flex items-center gap-2 w-full md:w-auto">
                        <select id="chapter-selector" class="glass-input rounded-xl px-3 py-2 md:px-4 md:py-2.5 font-bold w-full md:w-72 text-xs md:text-sm shadow-sm" onchange="selectChapter(this.value)"><option value="">é€‰æ‹©ç« èŠ‚...</option></select>
                        <span id="current-word-count" class="text-[10px] md:text-xs text-sub mono-font whitespace-nowrap bg-[var(--panel-bg)] px-2 md:px-3 py-1.5 rounded-lg border border-[var(--panel-border)]">0 W</span>
                    </div>
                    <div class="flex gap-2 w-full md:w-auto justify-end overflow-x-auto pb-1 md:pb-0">
                        <button onclick="toggleZenMode()" class="btn-ghost px-3 py-2 rounded-xl text-xs whitespace-nowrap" title="Zen æ¨¡å¼">ğŸ§˜</button>
                        <button onclick="aiCritique()" class="btn-ghost px-3 md:px-4 py-2 rounded-xl shadow-sm font-bold text-xs md:text-sm bg-red-500/5 hover:bg-red-500/10 text-red-400 border-red-400/20 whitespace-nowrap">ğŸŒ¶ï¸ å®¡ç¨¿</button>
                        <button onclick="generateChapterText(false)" class="btn-accent px-4 md:px-5 py-2 rounded-xl shadow-sm font-bold text-xs md:text-sm whitespace-nowrap">ğŸ–‹ï¸ èµ·ç¬”</button>
                        <button onclick="generateChapterText(true)" class="bg-emerald-600 hover:bg-emerald-500 text-white px-4 md:px-5 py-2 rounded-xl shadow-sm font-bold text-xs md:text-sm flex items-center gap-1 transition-colors whitespace-nowrap"><span>âœ’ï¸ ç»­å†™</span></button>
                    </div>
                </div>
                <div class="flex-grow relative rounded-b-2xl overflow-hidden bg-[var(--panel-bg)]">
                    <div id="loading-overlay" class="absolute inset-0 bg-black/60 backdrop-blur-sm z-30 hidden flex flex-col items-center justify-center"><div class="animate-spin text-5xl mb-6 text-accent filter drop-shadow-[0_0_15px_var(--accent-glow)]">ğŸ›¸</div><p class="text-xl font-bold serif-font text-main animate-pulse">å¼•æ“è½°é¸£ä¸­...</p></div>
                    <textarea id="chapter-editor" class="w-full h-full bg-transparent p-4 md:p-20 resize-none leading-loose text-base md:text-lg serif-font focus:outline-none placeholder-opacity-30 text-main" placeholder="åœ¨æ­¤å¤„å†™ä½œ...&#10;é€‰ä¸­æ–‡æœ¬å¯è§¦å‘ AI æ¶¦è‰²/æ‰©å†™å·¥å…·ã€‚" oninput="updateWordCount(); petHappy(); debounceSave()"></textarea>
                </div>
            </div>
        </section>
    </main>

    <footer class="w-full py-8 mt-12 border-t border-[var(--panel-border)] bg-[var(--input-bg)] text-center text-sub text-xs">
        <p>&copy; 2025 æ˜Ÿäº‘ç¬”å°– v3.8 | Powered by DeepSeek</p>
    </footer>

    <!-- Modals (All use w-11/12 max-w-[size]) -->
    
    <!-- Critique Modal -->
    <div id="critique-modal" class="fixed inset-0 z-[120] hidden">
        <div class="absolute inset-0 bg-black/90 backdrop-blur-sm transition-opacity" onclick="toggleCritiqueModal()"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 glass-panel rounded-2xl w-11/12 max-w-2xl shadow-[0_0_50px_rgba(239,68,68,0.2)] border border-red-500/30 overflow-hidden flex flex-col max-h-[85vh] animate-in fade-in zoom-in duration-300">
            <div class="p-4 md:p-5 border-b border-red-500/20 flex justify-between items-center bg-gradient-to-r from-red-900/40 to-transparent">
                <h3 class="text-lg md:text-xl font-bold text-red-200 flex items-center gap-3"><span class="text-2xl filter drop-shadow-[0_0_5px_red]">ğŸŒ¶ï¸</span> æ¯’èˆŒæŠ¥å‘Š</h3>
                <button onclick="toggleCritiqueModal()" class="text-red-300 hover:text-red-100 text-2xl leading-none">&times;</button>
            </div>
            <div class="p-4 md:p-6 overflow-y-auto custom-scrollbar flex-grow bg-[var(--input-bg)]">
                <div id="critique-content" class="text-xs md:text-sm text-gray-300 leading-loose font-mono whitespace-pre-wrap"></div>
            </div>
            <div class="p-4 md:p-5 border-t border-red-500/20 bg-black/40 flex gap-3 justify-end">
                <button onclick="copyCritique()" class="px-4 py-2 rounded-xl border border-red-500/30 text-red-300 text-xs md:text-sm font-bold flex items-center gap-2">ğŸ“„ å¤åˆ¶</button>
                <button onclick="toggleCritiqueModal()" class="btn-gradient from-red-600 to-rose-600 hover:from-red-500 hover:to-rose-500 px-5 py-2 rounded-xl text-white font-bold text-xs md:text-sm">ğŸ˜¤ æ¥å—æ‰¹è¯„</button>
            </div>
        </div>
    </div>

    <!-- Announcement Modal -->
    <div id="announcement-modal" class="fixed inset-0 z-[110] hidden">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="toggleAnnouncements()"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 glass-panel rounded-2xl w-11/12 max-w-lg shadow-2xl overflow-hidden flex flex-col max-h-[80vh]">
            <div class="p-5 border-b border-[var(--panel-border)] flex justify-between items-center bg-[var(--input-bg)]"><h3 class="text-lg font-bold text-main">ğŸ“¢ æ˜Ÿäº‘å¹¿æ’­</h3><button onclick="toggleAnnouncements()" class="text-sub hover:text-main text-2xl">&times;</button></div>
            <div id="announcement-list" class="flex-grow overflow-y-auto p-5 space-y-4"></div>
            <div class="p-5 border-t border-[var(--panel-border)] text-center bg-[var(--input-bg)]"><button onclick="markAllAsRead()" class="w-full btn-accent py-2.5 rounded-xl font-bold text-sm shadow-md">æˆ‘çŸ¥é“äº†</button></div>
        </div>
    </div>

    <!-- Tutorial Modal -->
    <div id="tutorial-modal" class="fixed inset-0 z-[110] hidden">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="toggleTutorial()"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 glass-panel rounded-2xl w-11/12 max-w-3xl shadow-2xl overflow-hidden flex flex-col max-h-[85vh]">
            <div class="p-6 border-b border-[var(--panel-border)] flex justify-between items-center bg-[var(--input-bg)]"><h3 class="text-xl font-bold serif-font text-accent flex items-center gap-2"><span>ğŸ“˜</span> èˆªè¡ŒæŒ‡å—</h3><button onclick="toggleTutorial()" class="text-sub hover:text-main text-2xl">&times;</button></div>
            <div class="p-6 md:p-8 overflow-y-auto text-sm text-sub leading-relaxed tutorial-body flex-grow">
                 <h4>ğŸš€ 1. å¼•æ“å¯åŠ¨</h4>
                <ul>
                    <li><b>API Key</b>: è¾“å…¥ DeepSeek Key (sk-...)ã€‚ç³»ç»Ÿè‡ªåŠ¨è¯†åˆ«ã€‚</li>
                </ul>
                <h4>ğŸŒ 2. ä¸–ç•Œæ„ç­‘</h4>
                <ul>
                    <li><b>åˆ›ä¸–æ¡£æ¡ˆ</b>: å·¦ä¾§å†™è®¾å®šï¼Œå³ä¾§çœ‹å›¾è°±ã€‚æ ¼å¼ï¼š<code>ã€çˆ¶èŠ‚ç‚¹ã€‘</code> æˆ– <code>å­èŠ‚ç‚¹ï¼šæè¿°</code>ã€‚æ”¯æŒç›´æ¥ç²˜è´´ Markdown æ ‡é¢˜ã€‚</li>
                    <li><b>æ˜Ÿå›¾äº¤äº’</b>: 
                        <br>â€¢ <b>PC</b>: æ»šè½®ç¼©æ”¾ï¼Œå·¦é”®æ‹–æ‹½ï¼ŒåŒå‡»å±…ä¸­ã€‚
                        <br>â€¢ <b>æ‰‹æœº</b>: å•æŒ‡æ‹–æ‹½æ¼«æ¸¸ï¼ŒåŒæŒ‡ç¼©æ”¾/æ—‹è½¬ã€‚
                    </li>
                </ul>
                <h4>âœï¸ 3. æ²‰æµ¸å†™ä½œ</h4>
                <ul>
                    <li><b>ç« èŠ‚ä¿®è®¢æ¨¡å—</b>: åœ¨ç»‡æœºä¸Šæ–¹ï¼Œå¯å®æ—¶ä¿®æ”¹å¤§çº²å¹¶è®¾å®š<b>å¼ºåˆ¶å­—æ•°</b>ã€‚</li>
                    <li><b>Zen æ¨¡å¼</b>: ç‚¹å‡» ğŸ§˜ è¿›å…¥å…¨å±ã€‚æ‰‹æœºç«¯ä¼šè‡ªåŠ¨éšè—æ— å…³å…ƒç´ å¹¶é˜²æ­¢é”®ç›˜é®æŒ¡ã€‚</li>
                    <li><b>æ¯’èˆŒå®¡ç¨¿</b>: ç‚¹å‡» ğŸŒ¶ï¸ï¼Œè®© AI ä¸»ç¼–å¯¹å½“å‰ç« èŠ‚è¿›è¡Œä¸¥å‰ç‚¹è¯„ã€‚</li>
                </ul>
                <h4>ğŸ–‹ï¸ 4. èµ·ç¬”</h4>
                <ul>
                    <li><b>AI èµ·ç¬”</b>: ç‚¹å‡» ğŸ–‹ï¸ï¼Œè®© AI ä¸»ç¼–ä¸ºä½ èµ·å¥½ç¬¬ä¸€å¥ã€‚</li>
                    <li><b>ç»­å†™</b>: ç‚¹å‡» âœ’ï¸ï¼Œè®© AI ä¸»ç¼–ä¸ºä½ ç»­å†™å‰©ä¸‹çš„éƒ¨åˆ†ã€‚</li>
                </ul>
                <h4>ğŸ¤– 5. æœºå™¨äººåŠ©æ‰‹</h4>
                <ul>
                    <li><b>AI åŠ©æ‰‹</b>: ç‚¹å‡» ğŸ¤–ï¼Œå¼€å¯ AI åŠ©æ‰‹ï¼Œå¯ä¸ AI è¿›è¡ŒèŠå¤©ã€å›ç­”é—®é¢˜ã€æå‡ºå»ºè®®ã€‚</li>
                    <li><b>AI æ¶¦è‰²</b>: é€‰ä¸­æ–‡æœ¬åï¼Œç‚¹å‡» AI åŠ©æ‰‹ä¸­çš„æ¶¦è‰²æŒ‰é’®ï¼Œè®© AI ä¸»ç¼–ä¸ºä½ æ”¹å†™ã€‚</li>
                    <li><b>AI æ‰©å†™</b>: é€‰ä¸­æ–‡æœ¬åï¼Œç‚¹å‡» AI åŠ©æ‰‹ä¸­çš„æ‰©å†™æŒ‰é’®ï¼Œè®© AI ä¸»ç¼–ä¸ºä½ ç”Ÿæˆæ–°å†…å®¹ã€‚</li>
                </ul>
                <h4> å¿«æ·é”®</h4>
                <ul>
                    <code>ctrl+zå¯ä»¥åˆ é™¤é™¤äº†apikeyä»¥å¤–çš„è¾“å…¥ã€‚</code>
                </ul>
                <h4>ğŸ‰ 6. å®Œæˆ</h4>
                <ul>
                    <li>æ­å–œä½ å®Œæˆäº†ä½ çš„ç¬¬ä¸€æœ¬æ˜Ÿäº‘ç¬”å°–ä½œå“ï¼</li>
                    <li>ç¥ä½ åœ¨æ˜Ÿäº‘çš„æ—…é€”æ„‰å¿«ï¼</li>
            </div>
            <div class="p-5 border-t border-[var(--panel-border)] text-center bg-[var(--input-bg)]"><button onclick="toggleTutorial()" class="btn-accent px-10 py-2.5 rounded-xl font-bold text-sm shadow-lg">å¼€å§‹åˆ›ä½œ</button></div>
        </div>
    </div>

    <!-- Disclaimer Modal -->
    <div id="disclaimer-modal" class="fixed inset-0 z-[120] hidden">
        <div class="absolute inset-0 bg-black/95 backdrop-blur-xl"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 glass-panel rounded-2xl w-11/12 max-w-2xl shadow-2xl border border-red-500/20 p-0 flex flex-col max-h-[85vh]">
            <div class="p-6 border-b border-[var(--panel-border)] bg-[var(--input-bg)]"><h3 class="text-xl font-bold text-red-400 flex items-center gap-2"><span>âš–ï¸</span> å…è´£å£°æ˜</h3></div>
            <div class="p-6 md:p-8 overflow-y-auto text-sm text-sub space-y-5 leading-relaxed flex-grow">
                <div class="bg-red-500/10 p-4 rounded-xl border border-red-500/20 text-red-200 font-bold">âš ï¸ è¯·åŠ¡å¿…é˜…è¯»ï¼šæœ¬åœ°åŒ–åº”ç”¨å£°æ˜</div>
               <p><b>1. AI ç”Ÿæˆå£°æ˜ï¼š</b> æœ¬å·¥å…·ç”Ÿæˆçš„æ‰€æœ‰å†…å®¹å‡ç”± DeepSeek äººå·¥æ™ºèƒ½æ¨¡å‹ç”Ÿæˆã€‚å†…å®¹å…·æœ‰éšæœºæ€§ï¼Œå¯èƒ½åŒ…å«è™šæ„ã€é”™è¯¯æˆ–ä¸å‡†ç¡®çš„ä¿¡æ¯ï¼ˆå¹»è§‰ï¼‰ã€‚ç”Ÿæˆå†…å®¹ä¸ä»£è¡¨å¼€å‘è€…ç«‹åœºï¼Œè¯·ç”¨æˆ·åœ¨ä½¿ç”¨å‰è‡ªè¡Œæ ¸å®ã€‚</p>
                <p><b>2. åˆè§„ä½¿ç”¨æ‰¿è¯ºï¼š</b> ç”¨æˆ·æ‰¿è¯ºä¸ä½¿ç”¨æœ¬å·¥å…·ç”Ÿæˆè¿åæ³•å¾‹æ³•è§„ã€è¿åå…¬åºè‰¯ä¿—ã€è‰²æƒ…ä½ä¿—ã€æš´åŠ›ææ€–ã€æ”¿æ²»æ•æ„Ÿæˆ–ä¾µçŠ¯ä»–äººæƒç›Šçš„å†…å®¹ã€‚å› ç”¨æˆ·ä¸å½“ä½¿ç”¨äº§ç”Ÿçš„ä¸€åˆ‡æ³•å¾‹è´£ä»»ç”±ç”¨æˆ·è‡ªè¡Œæ‰¿æ‹…ã€‚</p>
                <p><b>3. æ•°æ®éšç§ä¸å®‰å…¨ï¼š</b> æœ¬å·¥å…·ä¸º<b>çº¯é™æ€ç½‘é¡µåº”ç”¨</b>ã€‚æ‚¨çš„ API Keyã€å°è¯´è®¾å®šã€å¤§çº²å’Œæ­£æ–‡å‡<b>ä»…å­˜å‚¨åœ¨æ‚¨æœ¬åœ°æµè§ˆå™¨çš„ LocalStorage ä¸­</b>ï¼Œä¸ä¼šä¸Šä¼ è‡³æœ¬å·¥å…·å¼€å‘è€…çš„æœåŠ¡å™¨ã€‚</p>
                <p><b>4. ç‰ˆæƒå£°æ˜ï¼š</b> æœ¬å·¥å…·æ‰€å‘ˆç°çš„<b>æ‰€æœ‰å†…å®¹</b>ï¼ˆåŒ…æ‹¬ä½†ä¸é™äºå°è¯´è®¾å®šã€å¤§çº²ã€æ­£æ–‡ã€è§’è‰²è®¾å®šã€æ’ç”»ã€éŸ³ä¹ã€è§†é¢‘ç­‰ï¼‰<b>å‡å±äºåŸåˆ›</b>ï¼Œæœªç»åŸä½œè€…è®¸å¯ï¼Œä¸å¾—è½¬è½½ã€ä¿®æ”¹ã€å‡ºç‰ˆã€å‘è¡Œã€ä¸Šä¼ è‡³ä»»ä½•åª’ä½“å¹³å°ã€‚ä»»ä½•åª’ä½“å¹³å°æœªç»åŸä½œè€…è®¸å¯ï¼Œä¸å¾—ä½¿ç”¨æœ¬å·¥å…·æ‰€å‘ˆç°çš„ä»»ä½•å†…å®¹ã€‚</p>
                <p><b>5. å…è´£æ¡æ¬¾ï¼š</b> å¼€å‘è€…ä¸å¯¹å› ä½¿ç”¨æœ¬å·¥å…·è€Œäº§ç”Ÿçš„ä»»ä½•ç›´æ¥æˆ–é—´æ¥æŸå¤±è´Ÿè´£ã€‚åŒ…æ‹¬ä½†ä¸é™äºæ•°æ®ä¸¢å¤±ã€ç‰ˆæƒçº çº·ç­‰ã€‚</p>
                <p><b>6. å…¶ä»–å£°æ˜ï¼š</b> å¼€å‘è€…ä¿ç•™éšæ—¶ä¿®æ”¹ã€ä¸­æ­¢æˆ–ç»ˆæ­¢æœ¬å·¥å…·çš„æƒåˆ©ï¼Œå¼€å‘è€…å¯¹ç”¨æˆ·ä½¿ç”¨æœ¬å·¥å…·é€ æˆçš„ä»»ä½•æŸå¤±ä¸æ‰¿æ‹…ä»»ä½•è´£ä»»ã€‚</p>
                <p><b>7. qqè”ç³»æ–¹å¼ï¼š</b> å¦‚æœ‰ä»»ä½•ç–‘é—®æˆ–å»ºè®®ï¼Œè¯·è”ç³»å¼€å‘è€…ï¼š<a href="mailto:<EMAIL>" class="text-red-400 hover:text-red-200"><li><EMAIL>2537975460@qq.com</a></li></p>
                <P><b>8.è°·æ­Œé‚®ç®±ï¼š</b>å¦‚æœ‰ä»»ä½•ç–‘é—®æˆ–å»ºè®®ï¼Œè¯·è”ç³»å¼€å‘è€…ï¼š<a href="mailto:<EMAIL>" class="text-red-400 hover:text-red-200"><li>zh2335897181@gmail.com</a></li></P>
            </div>
            <div class="p-6 border-t border-[var(--panel-border)] text-center bg-[var(--input-bg)]"><button onclick="acceptDisclaimer()" class="btn-accent px-12 py-3 rounded-full font-bold shadow-xl hover:shadow-2xl transition-all hover:-translate-y-1">æˆ‘å·²é˜…è¯»å¹¶åŒæ„</button></div>
        </div>
    </div>

    <!-- Reset Modal -->
    <div id="reset-modal" class="fixed inset-0 z-[130] hidden">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="toggleResetModal()"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 glass-panel rounded-2xl w-11/12 max-w-sm shadow-2xl border border-red-500/30 p-6 flex flex-col items-center text-center">
            <div class="text-4xl mb-4">âš ï¸</div>
            <h3 class="text-lg font-bold text-main mb-2">ç¡®è®¤é‡ç½®åº”ç”¨ï¼Ÿ</h3>
            <p class="text-sm text-sub mb-6 leading-relaxed">æ¸…ç©ºæ‰€æœ‰å†…å®¹ (ä¿ç•™ API Key)ã€‚<br>æ“ä½œæ— æ³•æ’¤é”€ã€‚</p>
            <div class="flex gap-3 w-full">
                <button onclick="toggleResetModal()" class="flex-1 btn-ghost py-2.5 rounded-xl text-sm">å–æ¶ˆ</button>
                <button onclick="performReset()" class="flex-1 bg-red-500 hover:bg-red-600 text-white py-2.5 rounded-xl font-bold text-sm shadow-lg transition-colors">ç¡®è®¤é‡ç½®</button>
            </div>
        </div>
    </div>

    <!-- Tag Selector Modal -->
    <div id="tag-selector-modal" class="fixed inset-0 z-[120] hidden">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="toggleTagSelector()"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 glass-panel rounded-2xl w-11/12 max-w-2xl shadow-2xl overflow-hidden flex flex-col max-h-[85vh]">
            <div class="p-5 border-b border-[var(--panel-border)] flex justify-between items-center bg-[var(--input-bg)]"><h3 class="text-lg font-bold text-main flex items-center gap-2"><span class="text-xl">ğŸ·ï¸</span> æ ‡ç­¾å…¨ä¹¦</h3><button onclick="toggleTagSelector()" class="text-sub hover:text-main text-2xl leading-none">&times;</button></div>
            <div class="p-6 overflow-y-auto custom-scrollbar flex-grow bg-[var(--panel-bg)]" id="tag-list-container"></div>
            <div class="p-4 border-t border-[var(--panel-border)] bg-[var(--input-bg)] flex flex-col sm:flex-row gap-3">
                <div class="flex flex-1 gap-2"><input type="text" id="custom-tag-input" class="glass-input rounded-xl px-4 text-sm flex-grow" placeholder="è‡ªå®šä¹‰æ ‡ç­¾..."><button onclick="addCustomTag()" class="btn-ghost px-5 rounded-xl text-sm font-bold">æ·»åŠ </button></div>
                <button onclick="aiBrainstormTags()" class="btn-accent px-5 py-2.5 rounded-xl text-sm font-bold flex items-center gap-2 justify-center shadow-lg"><span>âœ¨ AI æ¨è</span></button>
                <button onclick="toggleTagSelector()" class="bg-emerald-600 hover:bg-emerald-500 text-white px-6 py-2.5 rounded-xl font-bold text-sm">å®Œæˆ</button>
            </div>
        </div>
    </div>

    <!-- Char Modal -->
    <div id="char-modal" class="fixed inset-0 z-[110] hidden">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="toggleModal('char-modal')"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 glass-panel rounded-2xl p-6 md:p-8 w-11/12 max-w-md shadow-2xl">
            <h3 class="text-xl font-bold mb-6 serif-font text-main">åˆ›é€ æ–°è§’è‰²</h3>
            <div class="space-y-4">
                <input type="text" id="new-char-name" placeholder="å§“å" class="glass-input w-full rounded-xl px-4 py-3 text-sm">
                <input type="text" id="new-char-role" placeholder="å®šä½ (å¦‚: ä¸»è§’)" class="glass-input w-full rounded-xl px-4 py-3 text-sm">
                <input type="text" id="new-char-tags" placeholder="æ ‡ç­¾ (é€—å·åˆ†éš”)" class="glass-input w-full rounded-xl px-4 py-3 text-sm">
                <textarea id="new-char-desc" placeholder="ç®€è¿°" class="glass-input w-full rounded-xl px-4 py-3 text-sm h-24"></textarea>
            </div>
            <div class="flex gap-4 mt-8">
                <button onclick="addManualCharacter()" class="flex-1 btn-accent py-2.5 rounded-xl font-bold text-sm shadow-lg">ä¿å­˜</button>
                <button onclick="toggleModal('char-modal')" class="flex-1 btn-ghost py-2.5 rounded-xl text-sm">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- JS Code embedded for single file distribution -->
    <script>
        // --- ç²’å­ç³»ç»Ÿ & Canvas ---
        class Particle { 
            constructor(width, height) { 
                this.x = Math.random() * width; 
                this.y = Math.random() * height; 
                this.vx = (Math.random()-0.5)*0.2; 
                this.vy = (Math.random()-0.5)*0.2; 
                this.size = Math.random()*2; 
                this.opacity = Math.random()*0.5; 
                this.fade = Math.random()*0.005; 
            } 
            update(width, height) { 
                this.x+=this.vx; this.y+=this.vy; this.opacity+=this.fade; 
                if(this.opacity>0.8||this.opacity<0.1) this.fade=-this.fade; 
                if(this.x<0)this.x=width; if(this.x>width)this.x=0; 
                if(this.y<0)this.y=height; if(this.y>height)this.y=0; 
            } 
            draw(ctx) { 
                let c='255,255,255'; 
                if(store.theme==='dawn')c='255,215,0'; 
                if(store.theme==='cyber')c='45,212,191'; 
                if(store.theme==='ink')c='60,60,60'; 
                ctx.beginPath(); 
                if(store.theme==='crystal'){ctx.moveTo(this.x,this.y-4);ctx.lineTo(this.x+1,this.y-1);ctx.lineTo(this.x+4,this.y);ctx.lineTo(this.x+1,this.y+1);ctx.lineTo(this.x,this.y+4);ctx.lineTo(this.x-1,this.y+1);ctx.lineTo(this.x-4,this.y);ctx.lineTo(this.x-1,this.y-1);}
                else{ctx.arc(this.x,this.y,this.size,0,Math.PI*2);} 
                ctx.fillStyle=`rgba(${c},${this.opacity})`; ctx.fill(); 
            } 
        }

        let particles = [];
        let canvasWidth, canvasHeight;

        function resizeCanvas() { 
            const canvas = document.getElementById('bg-canvas');
            if(!canvas) return;
            canvasWidth = window.innerWidth; 
            canvasHeight = window.innerHeight; 
            canvas.width = canvasWidth; 
            canvas.height = canvasHeight; 
        }

        function initP() { 
            particles=[]; 
            for(let i=0;i<60;i++) particles.push(new Particle(canvasWidth, canvasHeight)); 
        } 

        function animP() { 
            const canvas = document.getElementById('bg-canvas');
            if(!canvas) return;
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0,0,canvasWidth,canvasHeight); 
            particles.forEach(p=>{p.update(canvasWidth, canvasHeight);p.draw(ctx);}); 
            requestAnimationFrame(animP); 
        }

        // --- æ ¸å¿ƒçŠ¶æ€ ---
        let store = { 
            defaultWordCount: '2000-3000', 
            apiKey: '', 
            concept: '', 
            lore: '', 
            targetChapters: 100, 
            characters: [], 
            outline: [], 
            currentChapterId: null, 
            chapterTexts: {}, 
            theme: 'crystal', 
            tags: [], 
            engine: 'none',
            baseUrl: 'https://api.deepseek.com/chat/completions'
        };
        let saveTimeout;
        const NOVEL_TAGS = { "ğŸ† ç”·é¢‘ç²¾é€‰": ["ç„å¹»", "éƒ½å¸‚", "ä»™ä¾ ", "ç§‘å¹»", "æ‚¬ç–‘", "å¥‡å¹»", "å†å²", "æ¸¸æˆ", "ä½“è‚²", "å†›äº‹", "æ­¦ä¾ ", "è½»å°è¯´"], "ğŸŒ¸ å¥³é¢‘ç²¾é€‰": ["ç°è¨€", "å¤è¨€", "å¹»è¨€", "æ ¡å›­", "é’æ˜¥", "çº¯çˆ±", "å®«æ–—", "é‡ç”Ÿ", "ç§ç”°", "è±ªé—¨", "å¥³å¼º", "å¿«ç©¿"], "âš¡ æ ¸å¿ƒå…ƒç´ ": ["ç³»ç»Ÿ", "ç¥åŒ»", "è„‘æ´", "é‰´å®", "ææ€–", "æ¨ç†", "è°æˆ˜", "æœ«ä¸–", "æ— é™æµ", "èµ›åšæœ‹å…‹", "å…‹è‹é²", "çµæ°”å¤è‹", "è¯¸å¤©ä¸‡ç•Œ"], "ğŸ­ ä¸»è§’äººè®¾": ["è…¹é»‘", "é«˜å†·", "ç—…å¨‡", "èµ˜å©¿", "æˆ˜ç¥", "ç¥è±ª", "å­¦éœ¸", "å¥¶çˆ¸", "æ€ä¼æœæ–­", "æ™ºå•†åœ¨çº¿", "åæ´¾", "è€å…­"], "ğŸ¨ é£æ ¼åŸºè°ƒ": ["çˆ½æ–‡", "æç¬‘", "è½»æ¾", "çƒ­è¡€", "æš—é»‘", "æ²»æ„ˆ", "ç”œå® ", "è™æ–‡", "æ— æ•Œ", "è¿ªåŒ–", "ç¾¤åƒ", "å¹•åæµ"] };
        const systemAnnouncements = [
            { id: 999, title: "ğŸ”‘ æ–°æ‰‹å¿…è¯»ï¼šå…è´¹è·å– DeepSeek API Key", date: "ç½®é¡¶", type: "important", content: `<div class="space-y-2"><p>DeepSeek æ³¨å†Œå³é€å…è´¹é¢åº¦ï¼Œæ— éœ€ç»‘å¡ï¼</p><ol class="list-decimal pl-4 space-y-1 opacity-80"><li>è®¿é—® <a href="https://platform.deepseek.com/" target="_blank" class="underline font-bold text-accent">DeepSeek å¼€æ”¾å¹³å°</a>ã€‚</li><li>ç‚¹å‡»å·¦ä¾§ <b>API Keys</b> èœå• -> <b>Create API Key</b>ã€‚</li><li>å¤åˆ¶ <code class="bg-black/20 px-1 rounded border border-white/10">sk-</code> å¼€å¤´çš„å¯†é’¥ï¼Œç²˜è´´åˆ°æœ¬ç½‘é¡µå³ä¸Šè§’ã€‚</li></ol></div>` },
            { id: 305, title: "v3.8 è‡ªé€‚åº”æ›´æ–°", date: "2025-07-05", type: "update", content: "â€¢ <b>ç§»åŠ¨ç«¯ä¼˜åŒ–</b>: å…¨é¢é€‚é…æ‰‹æœºå’Œå¹³æ¿ï¼Œå†™ä½œéšæ—¶éšåœ°ã€‚<br>â€¢ <b>å¸ƒå±€è°ƒæ•´</b>: ä¼˜åŒ–äº†å·¥å…·æ å’Œå¯¼èˆªåœ¨å°å±å¹•ä¸Šçš„è¡¨ç°ã€‚" }
        ];

        // --- åˆå§‹åŒ– & ç”Ÿå‘½å‘¨æœŸ ---
        window.onload = function() {
            // Core
            loadData(); 
            changeTheme(store.theme || 'crystal'); 
            
            // Background
            resizeCanvas(); 
            initP(); 
            animP(); 
            window.addEventListener('resize', resizeCanvas);

            // Clock & Engine
            setInterval(updateClock, 1000); 
            updateClock(); 
            detectEngine();
            
            // UI Render
            renderTagSelector(); 
            renderSelectedTags(); 
            
            // åè®®æ£€æŸ¥
            const hasAgreed = localStorage.getItem('agreed_to_terms_v1'); 
            if(hasAgreed!=='true') showDisclaimer(false); 
            else checkAndAutoPopAnnouncements();

            // Event Listeners
            document.addEventListener('click', (e) => { 
                const m = document.getElementById('theme-menu'); const b = document.getElementById('theme-btn'); 
                if(m && !m.contains(e.target) && !b.contains(e.target)) m.classList.add('hidden'); 
            });

            const editor = document.getElementById('chapter-editor');
            if(editor) {
                editor.addEventListener('mouseup', handleSelection);
                editor.addEventListener('keyup', handleSelection);
                // ç§»åŠ¨ç«¯é€‰æ‹©ç›‘å¬ (touch events)
                editor.addEventListener('touchend', handleSelection);
            }
            document.addEventListener('mousedown', (e) => {
                const toolbar = document.getElementById('ai-toolbar');
                if (toolbar && !toolbar.contains(e.target) && e.target !== editor) toolbar.classList.remove('visible');
            });
            document.addEventListener('touchstart', (e) => {
                const toolbar = document.getElementById('ai-toolbar');
                if (toolbar && !toolbar.contains(e.target) && e.target !== editor) toolbar.classList.remove('visible');
            });
            
            // Init Base URL Input
            const urlInput = document.getElementById('custom-base-url');
            if(urlInput && store.baseUrl) urlInput.value = store.baseUrl;

            setTimeout(petHappy, 1000);
        };

        // --- Lore Tab Logic ---
        let loreNodes = [];
        let loreOffset = { x: 0, y: 0 };
        let loreScale = 1; 
        let isDraggingLore = false;
        let lastLoreMousePos = { x: 0, y: 0 };
        let loreViewMode = 'text';
        let loreAnimationId = null;
        let lastTouchDist = 0;

        function setLoreView(mode) {
            loreViewMode = mode;
            const textView = document.getElementById('lore-text-view');
            const graphView = document.getElementById('lore-graph-view');
            const btnText = document.getElementById('btn-lore-text');
            const btnGraph = document.getElementById('btn-lore-graph');

            if(mode === 'text') {
                textView.classList.remove('hidden');
                graphView.classList.add('hidden');
                cancelAnimationFrame(loreAnimationId);
                btnText.className = "px-3 py-1 text-xs font-bold rounded-md bg-[var(--panel-bg)] text-accent shadow-sm transition-all";
                btnGraph.className = "px-3 py-1 text-xs font-bold rounded-md text-sub hover:text-main transition-all";
            } else {
                textView.classList.add('hidden');
                graphView.classList.remove('hidden');
                btnGraph.className = "px-3 py-1 text-xs font-bold rounded-md bg-[var(--panel-bg)] text-accent shadow-sm transition-all";
                btnText.className = "px-3 py-1 text-xs font-bold rounded-md text-sub hover:text-main transition-all";
                setTimeout(() => { parseLoreToGraph(); animateLoreGraph(); }, 50); 
            }
        }

        function parseLoreToGraph() {
            const text = document.getElementById('novel-lore').value;
            const lines = text.split('\n');
            const canvas = document.getElementById('lore-canvas');
            const parent = canvas.parentElement;
            canvas.width = parent.clientWidth;
            canvas.height = parent.clientHeight;
            loreOffset = { x: canvas.width / 2, y: canvas.height / 2 }; 
            loreScale = 1;
            loreNodes = [];
            let currentParentIndex = -1;

            lines.forEach((line) => {
                line = line.trim();
                if(!line) return;
                if(line.includes('åç§°ï¼šæè¿°') || line.includes('ä¾‹å¦‚ï¼š') || line.includes('æ ¼å¼æç¤º')) return;

                if((line.startsWith('ã€') && line.endsWith('ã€‘')) || line.startsWith('#')) {
                    const label = line.replace(/[ã€ã€‘#]/g, '').trim();
                    loreNodes.push({ label, type: 'category', x: (Math.random()-0.5)*50, y: (Math.random()-0.5)*50, vx:0, vy:0, radius: 40, color: '#c084fc', connections: [] });
                    currentParentIndex = loreNodes.length - 1;
                } else if (currentParentIndex !== -1) {
                    let label = line;
                    let desc = "";
                    if(line.match(/[:ï¼š]/)) {
                        const parts = line.split(/[:ï¼š]/);
                        label = parts[0];
                        desc = parts.slice(1).join(':');
                    }
                    label = label.replace(/^[\s\d\.\-\*\>\â€¢\+]+/g, '').trim();

                    if(label.length > 0) {
                        const parent = loreNodes[currentParentIndex];
                        loreNodes.push({ label, desc, type: 'item', x: parent.x+(Math.random()-0.5)*20, y: parent.y+(Math.random()-0.5)*20, vx:0, vy:0, radius: 25, color: '#818cf8', parentId: currentParentIndex });
                        parent.connections.push(loreNodes.length - 1);
                    }
                }
            });
            if(loreNodes.length === 0) loreNodes.push({ label: "æ— æ•°æ®", type: 'category', x: 0, y: 0, vx:0, vy:0, radius: 60, color: '#94a3b8', connections: [] });
        }

        function updateLorePhysics() {
            const repulsion = 15000; const springLength = 180; const k = 0.04; const maxVel = 10;
            for(let i=0; i<loreNodes.length; i++) {
                let nodeA = loreNodes[i];
                for(let j=i+1; j<loreNodes.length; j++) {
                    let nodeB = loreNodes[j];
                    let dx = nodeA.x - nodeB.x; let dy = nodeA.y - nodeB.y;
                    let distSq = dx*dx + dy*dy || 1; let dist = Math.sqrt(distSq);
                    if(dist < 800) {
                        let f = repulsion / distSq; let fx = (dx / dist) * f; let fy = (dy / dist) * f;
                        nodeA.vx += fx; nodeA.vy += fy; nodeB.vx -= fx; nodeB.vy -= fy;
                    }
                }
                if(nodeA.parentId !== undefined) {
                    let parent = loreNodes[nodeA.parentId];
                    let dx = nodeA.x - parent.x; let dy = nodeA.y - parent.y;
                    let dist = Math.sqrt(dx*dx + dy*dy) || 1;
                    let f = (dist - springLength) * k; let fx = (dx / dist) * f; let fy = (dy / dist) * f;
                    nodeA.vx -= fx; nodeA.vy -= fy; parent.vx += fx; parent.vy += fy;
                }
                nodeA.vx -= nodeA.x * 0.002; nodeA.vy -= nodeA.y * 0.002;
            }
            loreNodes.forEach(node => {
                node.vx = Math.max(-maxVel, Math.min(maxVel, node.vx));
                node.vy = Math.max(-maxVel, Math.min(maxVel, node.vy));
                node.x += node.vx; node.y += node.vy; node.vx *= 0.9; node.vy *= 0.9;
            });
        }

        function animateLoreGraph() {
            if(loreViewMode !== 'graph') return;
            updateLorePhysics();
            drawLoreGraph();
            loreAnimationId = requestAnimationFrame(animateLoreGraph);
        }

        function drawLoreGraph() {
            const canvas = document.getElementById('lore-canvas');
            if(!canvas) return;
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.save();
            ctx.translate(loreOffset.x, loreOffset.y);
            ctx.scale(loreScale, loreScale);
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.2)';
            ctx.lineWidth = 2 / loreScale;
            loreNodes.forEach((node) => { if(node.parentId !== undefined) { const parent = loreNodes[node.parentId]; ctx.beginPath(); ctx.moveTo(parent.x, parent.y); ctx.lineTo(node.x, node.y); ctx.stroke(); } });
            loreNodes.forEach(node => {
                ctx.shadowBlur = 20; ctx.shadowColor = node.color;
                ctx.beginPath();
                for (let i = 0; i < 6; i++) { ctx.lineTo(node.x + node.radius * Math.cos(i * Math.PI / 3), node.y + node.radius * Math.sin(i * Math.PI / 3)); }
                ctx.closePath(); ctx.fillStyle = 'rgba(15, 23, 42, 0.9)'; ctx.fill(); ctx.strokeStyle = node.color; ctx.lineWidth = 2 / loreScale; ctx.stroke(); ctx.shadowBlur = 0;
                ctx.fillStyle = '#fff';
                const fontSize = (node.type === 'category' ? 14 : 10) / (loreScale > 1 ? 1 : loreScale * 0.8);
                ctx.font = `bold ${Math.max(8, fontSize)}px Inter`; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText(node.label, node.x, node.y);
            });
            ctx.restore();
        }

        // --- Interaction Handlers ---
        const loreCanvas = document.getElementById('lore-canvas');
        function getPointerPos(e) {
            const rect = loreCanvas.getBoundingClientRect();
            let cx = e.touches ? e.touches[0].clientX : e.clientX;
            let cy = e.touches ? e.touches[0].clientY : e.clientY;
            return { x: cx - rect.left, y: cy - rect.top };
        }
        function handleStart(e) {
            if(e.type === 'touchstart' && e.touches.length === 2) { lastTouchDist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY); return; }
            isDraggingLore = true; lastLoreMousePos = getPointerPos(e); loreCanvas.style.cursor = 'grabbing';
        }
        function handleMove(e) {
            // Only prevent default if we are actually dragging/interacting with canvas
            // to allow page scroll when touching outside nodes? For now keep preventDefault for smooth graph
            if(e.target === loreCanvas) {
               // e.preventDefault(); // Commented out to allow scroll if needed, but for canvas best to prevent
               if(e.cancelable) e.preventDefault(); 
            }
            if(e.type === 'touchmove' && e.touches.length === 2) {
                const dist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
                if(lastTouchDist > 0) { const zoom = Math.exp((dist - lastTouchDist) * 0.01); loreScale = Math.min(Math.max(0.1, loreScale * zoom), 5); }
                lastTouchDist = dist; return;
            }
            if(isDraggingLore) { const pos = getPointerPos(e); loreOffset.x += pos.x - lastLoreMousePos.x; loreOffset.y += pos.y - lastLoreMousePos.y; lastLoreMousePos = pos; }
        }
        function handleWheel(e) { e.preventDefault(); const zoom = Math.exp((e.deltaY < 0 ? 1 : -1) * 0.1); const rect = loreCanvas.getBoundingClientRect(); const mx = e.clientX - rect.left; const my = e.clientY - rect.top; const wx = (mx - loreOffset.x) / loreScale; const wy = (my - loreOffset.y) / loreScale; loreScale = Math.min(Math.max(0.1, loreScale * zoom), 5); loreOffset.x = mx - wx * loreScale; loreOffset.y = my - wy * loreScale; }

        if(loreCanvas) {
            loreCanvas.addEventListener('mousedown', handleStart); loreCanvas.addEventListener('touchstart', handleStart, {passive: false});
            window.addEventListener('mouseup', () => { isDraggingLore = false; loreCanvas.style.cursor = 'grab'; }); window.addEventListener('touchend', () => isDraggingLore = false);
            loreCanvas.addEventListener('mousemove', handleMove); loreCanvas.addEventListener('touchmove', handleMove, {passive: false});
            loreCanvas.addEventListener('wheel', handleWheel);
            loreCanvas.addEventListener('dblclick', () => { loreOffset = { x: loreCanvas.width / 2, y: loreCanvas.height / 2 }; loreScale = 1; });
        }

        // --- Data Logic ---
        function updateBaseUrl() {
            const input = document.getElementById('custom-base-url');
            if(input) {
                store.baseUrl = input.value.trim() || 'https://api.deepseek.com/chat/completions';
                saveData();
                showToast("Base URL å·²æ›´æ–°", "success");
            }
        }
        function updateDefaultWords() {
            const input = document.getElementById('setting-default-words');
            if(input) {
                store.defaultWordCount = input.value.trim() || '2000-3000';
                saveData();
                showToast("é»˜è®¤å­—æ•°å·²æ›´æ–°", "success");
            }
        }

        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(store));
            const a = document.createElement('a'); a.href = dataStr; a.download = "nebula_quill_backup_" + new Date().toISOString().slice(0,10) + ".json";
            document.body.appendChild(a); a.click(); a.remove(); showToast("å¤‡ä»½å·²ä¸‹è½½", "success");
        }
        function importData(input) {
            const file = input.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try { const data = JSON.parse(e.target.result); if(data.characters && data.outline) { store = {...store, ...data}; saveData(); location.reload(); } else { showToast("æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®", "error"); } } catch(err) { showToast("å¯¼å…¥å¤±è´¥: " + err.message, "error"); }
            }; reader.readAsText(file);
        }
        function handleSelection(e) {
            const editor = document.getElementById('chapter-editor'); const toolbar = document.getElementById('ai-toolbar');
            const start = editor.selectionStart; const end = editor.selectionEnd;
            if (start !== end) {
                currentSelectionRange = { start, end, text: editor.value.substring(start, end) };
                // ä¼˜åŒ–æ‰‹æœºç«¯å·¥å…·æ ä½ç½®
                const isMobile = window.innerWidth < 640;
                if(!isMobile) {
                    if(e.type === 'mouseup' || e.type === 'keyup') { toolbar.style.left = `${Math.min(e.clientX - 50, window.innerWidth - 250)}px`; toolbar.style.top = `${Math.max(e.clientY - 60, 20)}px`; }
                }
                toolbar.classList.add('visible');
            } else { toolbar.classList.remove('visible'); }
        }
        async function aiAssist(type) {
            if(!currentSelectionRange) return;
            const toolbar = document.getElementById('ai-toolbar'); toolbar.classList.remove('visible');
            let prompt = ""; if(type === 'polish') prompt = "è¯·æ¶¦è‰²ä»¥ä¸‹æ®µè½ï¼Œä½¿å…¶æ–‡ç¬”æ›´ä¼˜ç¾ï¼š"; if(type === 'expand') prompt = "è¯·æ‰©å†™ä»¥ä¸‹æ®µè½ï¼Œå¢åŠ ç»†èŠ‚ï¼š"; if(type === 'shorten') prompt = "è¯·ç²¾ç®€ä»¥ä¸‹æ®µè½ï¼š"; if(type === 'synonym') prompt = "è¯·é‡å†™ä»¥ä¸‹å¥å­ï¼š";
            showToast("AI æ­£åœ¨æ–½æ³•...", "info");
            try { const res = await callAI([{role: "system", content: "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ–‡å­¦ç¼–è¾‘ã€‚ç›´æ¥è¿”å›ä¿®æ”¹åçš„æ–‡æœ¬ã€‚"}, {role: "user", content: `${prompt}\n\n"${currentSelectionRange.text}"`}]); const editor = document.getElementById('chapter-editor'); editor.setRangeText(res, currentSelectionRange.start, currentSelectionRange.end, 'select'); showToast("ä¿®æ”¹å®Œæˆ", "success"); updateWordCount(); saveData(); } catch(e) { showToast("è¾…åŠ©å¤±è´¥: " + e.message, "error"); }
        }
        function toggleZenMode() { document.body.classList.toggle('zen-mode'); if(document.body.classList.contains('zen-mode')) showToast("å·²è¿›å…¥ç¦…æ¨¡å¼", "info"); }

        // --- æ¯’èˆŒå®¡ç¨¿ UI é€»è¾‘ ---
        function toggleCritiqueModal() { document.getElementById('critique-modal').classList.toggle('hidden'); }
        function copyCritique() { const text = document.getElementById('critique-content').innerText; navigator.clipboard.writeText(text); showToast("å¤åˆ¶æˆåŠŸï¼Œè¯·å«æ³ªä¿®æ”¹", "success"); }

        async function aiCritique() {
            const content = document.getElementById('chapter-editor').value; 
            if(content.length < 200) return showToast("å­—æ•°å¤ªå°‘ï¼ŒAI æ‡’å¾—å–·", "info");
            
            showToast("æ¯’èˆŒç¼–è¾‘æ­£åœ¨ç£¨åˆ€...", "info");
            
            const critiqueBox = document.getElementById('critique-content');
            critiqueBox.innerHTML = '<span class="animate-pulse">æ­£åœ¨é˜…è¯»...</span>';
            document.getElementById('critique-modal').classList.remove('hidden');
            
            let fullResponse = "";

            try { 
                const prompt = `ä½ æ˜¯ä¸€ä¸ªéå¸¸ä¸¥æ ¼ã€æ¯’èˆŒçš„èµ„æ·±ç½‘æ–‡ä¸»ç¼–ã€‚è¯·å¯¹ä»¥ä¸‹æ­£æ–‡è¿›è¡ŒçŠ€åˆ©ç‚¹è¯„ã€‚
                è¯·æŒ‰ä»¥ä¸‹æ ¼å¼è¿”å›ï¼ˆä¸è¦Markdownä»£ç å—ï¼‰ï¼š
                ã€ç»¼åˆè¯„åˆ†ã€‘ï¼šX/10
                ã€æ¯’ç‚¹æ‰«æã€‘ï¼š(åˆ—å‡ºé€»è¾‘æ¼æ´ã€äººè®¾å´©å¡Œç­‰)
                ã€èŠ‚å¥åˆ†æã€‘ï¼š(å‰§æƒ…æ˜¯å¦æ‹–æ²“)
                ã€ä¿®æ”¹å»ºè®®ã€‘ï¼š(ç»™å‡ºä¸€é’ˆè§è¡€çš„å»ºè®®)
                
                æ­£æ–‡å†…å®¹ï¼š
                ${content.slice(-2000)}`;

                await callAI([{role: 'user', content: prompt}], (chunk) => {
                    fullResponse += chunk;
                    let formatted = fullResponse.replace(/ã€(.*?)ã€‘/g, '<span class="critique-highlight">ã€$1ã€‘</span>');
                    critiqueBox.innerHTML = formatted;
                    const container = critiqueBox.parentElement;
                    container.scrollTop = container.scrollHeight;
                }); 
                
            } catch(e) { 
                showToast("å®¡ç¨¿å¤±è´¥: " + e.message, "error");
                critiqueBox.innerHTML += `\n\n[å‡ºé”™]: ${e.message}`;
            }
        }

        // --- Character Graph Logic ---
        let graphNodes = []; let graphOffset = { x: 0, y: 0 }; let isDraggingGraph = false; let lastMousePos = { x: 0, y: 0 };
        function initGraph() {
            const canvas = document.getElementById('graph-canvas'); if(!canvas) return;
            const parent = canvas.parentElement; canvas.width = parent.clientWidth; canvas.height = parent.clientHeight;
            const chars = store.characters.length > 0 ? store.characters : [{name: "ä¸»è§’", role: "æ ¸å¿ƒ"}, {name: "åæ´¾", role: "å¯¹ç«‹"}];
            graphNodes = chars.map((c, i) => { const angle = (i/chars.length)*Math.PI*2; return { name: c.name, role: c.role, x: canvas.width/2+Math.cos(angle)*150, y: canvas.height/2+Math.sin(angle)*150, color: i===0?'#f43f5e':'#818cf8' }; });
            drawGraph();
        }
        function drawGraph() {
            const canvas = document.getElementById('graph-canvas'); if(!canvas) return; const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height); ctx.save(); ctx.translate(graphOffset.x, graphOffset.y);
            ctx.strokeStyle = 'rgba(255,255,255,0.1)'; ctx.lineWidth = 1;
            for(let i=0;i<graphNodes.length;i++) for(let j=i+1;j<graphNodes.length;j++) { ctx.beginPath(); ctx.moveTo(graphNodes[i].x, graphNodes[i].y); ctx.lineTo(graphNodes[j].x, graphNodes[j].y); ctx.stroke(); }
            graphNodes.forEach(n => { const g = ctx.createRadialGradient(n.x,n.y,5,n.x,n.y,25); g.addColorStop(0,n.color); g.addColorStop(1,'rgba(0,0,0,0)'); ctx.fillStyle=g; ctx.beginPath(); ctx.arc(n.x,n.y,25,0,Math.PI*2); ctx.fill(); ctx.fillStyle='#fff'; ctx.font='12px Inter'; ctx.textAlign='center'; ctx.fillText(n.name,n.x,n.y+20); });
            ctx.restore();
        }
        const graphCanvas = document.getElementById('graph-canvas');
        if(graphCanvas) {
            graphCanvas.addEventListener('mousedown', e => { isDraggingGraph=true; const r=graphCanvas.getBoundingClientRect(); lastMousePos={x:e.clientX-r.left,y:e.clientY-r.top}; });
            graphCanvas.addEventListener('touchstart', e => { isDraggingGraph=true; const r=graphCanvas.getBoundingClientRect(); const t=e.touches[0]; lastMousePos={x:t.clientX-r.left,y:t.clientY-r.top}; }, {passive: false});
            graphCanvas.addEventListener('mousemove', e => { if(isDraggingGraph){ const r=graphCanvas.getBoundingClientRect(); const cx=e.clientX-r.left; const cy=e.clientY-r.top; graphOffset.x+=cx-lastMousePos.x; graphOffset.y+=cy-lastMousePos.y; lastMousePos={x:cx,y:cy}; drawGraph(); } });
            graphCanvas.addEventListener('touchmove', e => { if(isDraggingGraph){ e.preventDefault(); const r=graphCanvas.getBoundingClientRect(); const t=e.touches[0]; const cx=t.clientX-r.left; const cy=t.clientY-r.top; graphOffset.x+=cx-lastMousePos.x; graphOffset.y+=cy-lastMousePos.y; lastMousePos={x:cx,y:cy}; drawGraph(); } }, {passive: false});
            window.addEventListener('mouseup', () => isDraggingGraph=false);
            window.addEventListener('touchend', () => isDraggingGraph=false);
        }

        // --- Common Helpers ---
        function renderTagSelector() { const c = document.getElementById('tag-list-container'); if(c) { let h=''; for(const [k,v] of Object.entries(NOVEL_TAGS)) { h+=`<div class="mb-5"><h4 class="text-xs font-bold text-sub mb-3 opacity-80 border-b border-[var(--panel-border)] pb-1">${k}</h4><div class="flex flex-wrap gap-2">${v.map(t=>`<div onclick="toggleTag('${t}')" class="tag-selectable ${store.tags.includes(t)?'selected':''}">${t}</div>`).join('')}</div></div>`; } c.innerHTML=h; } }
        function toggleTag(t) { if(store.tags.includes(t)) store.tags=store.tags.filter(x=>x!==t); else store.tags.push(t); renderTagSelector(); renderSelectedTags(); saveData(); }
        function renderSelectedTags() { const c = document.getElementById('selected-tags-container'); if(c) c.innerHTML = store.tags.map(t=>`<span class="novel-tag">${t} <span onclick="toggleTag('${t}');event.stopPropagation()" class="tag-remove">Ã—</span></span>`).join(''); }
        function toggleTagSelector() { document.getElementById('tag-selector-modal').classList.toggle('hidden'); if(!document.getElementById('tag-selector-modal').classList.contains('hidden')) renderTagSelector(); }
        function addCustomTag() { const i=document.getElementById('custom-tag-input'); const v=i.value.trim(); if(v&&!store.tags.includes(v)){ store.tags.push(v); i.value=''; renderTagSelector(); renderSelectedTags(); saveData(); } }
        function updateClock() { document.getElementById('live-clock').innerText = new Date().toLocaleTimeString(); }
        function debounceSave() { const s=document.getElementById('save-status'); if(s) { s.innerText="Writing..."; clearTimeout(saveTimeout); saveTimeout=setTimeout(saveData, 1000); } petHappy(); }
        function toggleThemeMenu() { const m=document.getElementById('theme-menu'); m.classList.toggle('hidden'); if(!m.classList.contains('hidden')) m.classList.add('dropdown-enter'); }
        function changeTheme(n) { document.documentElement.setAttribute('data-theme', n); store.theme=n; saveData(); document.getElementById('theme-menu').classList.add('hidden'); }
        function switchTab(id) { 
            ['tab-prompt','tab-lore','tab-graph'].forEach(t=>document.getElementById(t).classList.add('hidden')); 
            ['btn-tab-prompt','btn-tab-lore','btn-tab-graph'].forEach(b=>document.getElementById(b).className="flex-1 px-2 md:px-4 py-2 text-xs md:text-sm font-bold rounded-xl transition-all duration-300 opacity-60 hover:opacity-100 hover:bg-[var(--panel-bg)] whitespace-nowrap"); 
            document.getElementById(id).classList.remove('hidden'); 
            document.getElementById('btn-'+id).className="flex-1 px-2 md:px-4 py-2 text-xs md:text-sm font-bold rounded-xl transition-all duration-300 shadow-md bg-[var(--panel-bg)] text-accent whitespace-nowrap"; 
            if(id==='tab-graph') initGraph(); 
        }
        function toggleModal(id) { document.getElementById(id).classList.toggle('hidden'); }
        function showToast(m, t='info') { Toastify({ text: m, duration: 3000, gravity: "top", position: "center", style: { background: t==='success'?"#10b981":"#f43f5e" }, className: "rounded-lg shadow-lg font-bold text-sm" }).showToast(); }
        function saveData() { store.apiKey=document.getElementById('api-key').value; store.concept=document.getElementById('novel-prompt').value; store.lore=document.getElementById('novel-lore').value; store.targetChapters=document.getElementById('target-total-chapters').value; localStorage.setItem('deepseek_novel_data_v2', JSON.stringify(store)); const s=document.getElementById('save-status'); if(s){s.innerText="â— Saved "+new Date().toLocaleTimeString();s.style.color="var(--accent-color)";} }
        function loadData() { const s=localStorage.getItem('deepseek_novel_data_v2')||localStorage.getItem('deepseek_novel_data_v1'); if(s){ try{ const p=JSON.parse(s); store={...store,...p}; if(!store.tags) store.tags=[]; if(!store.baseUrl) store.baseUrl='https://api.deepseek.com/chat/completions'; document.getElementById('api-key').value=store.apiKey||''; document.getElementById('novel-prompt').value=store.concept||''; document.getElementById('novel-lore').value=store.lore||''; document.getElementById('target-total-chapters').value=store.targetChapters||100; if(store.characters.length) renderCharacters(); if(store.outline.length){ renderOutline(); document.getElementById('section-outline').classList.remove('hidden'); if(store.currentChapterId){ activateLoom(); document.getElementById('chapter-selector').value=store.currentChapterId; loadChapterText(); }} renderSelectedTags(); detectEngine(); }catch(e){} } }
        function clearAllData() { toggleResetModal(); }
        function toggleResetModal() { document.getElementById('reset-modal').classList.toggle('hidden'); }

        function performReset() { 
            const currentKey = store.apiKey || document.getElementById('api-key').value;
            localStorage.clear(); 
            if(currentKey) {
                const freshData = { apiKey: currentKey };
                localStorage.setItem('deepseek_novel_data_v2', JSON.stringify(freshData));
            }
            location.reload(); 
        }

        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'z') {
                const tag = e.target.tagName.toUpperCase();
                const isEditable = e.target.isContentEditable;
                if (tag !== 'INPUT' && tag !== 'TEXTAREA' && !isEditable) {
                    e.preventDefault(); 
                    toggleResetModal(); 
                }
            }
        });

        function downloadNovel() { if(!store.outline.length) return showToast("æ— å†…å®¹", "error"); let c=`ã€Š${store.concept.substring(0,10)}ã€‹\n${store.concept}\n${store.lore}\n\n`; store.outline.forEach(ch=>c+=`${ch.title}\n${store.chapterTexts[ch.id]||''}\n\n`); const b=new Blob([c],{type:"text/plain"}); const u=URL.createObjectURL(b); const a=document.createElement("a"); a.href=u; a.download="å°è¯´.txt"; a.click(); }

        // --- Engine Detection ---
        function detectEngine() { 
            const k=document.getElementById('api-key').value.trim(); 
            const d=document.getElementById('engine-dot'); 
            const n=document.getElementById('engine-name'); 
            if(!d||!n) return; 
            
            if(k.startsWith('sk-')){
                store.engine='deepseek';
                d.className="w-2 h-2 rounded-full bg-blue-500 shadow-[0_0_5px_rgba(59,130,246,0.8)]";
                n.innerText="DeepSeek";
                n.className="text-blue-300 font-bold";
            } else {
                store.engine='none';
                d.className="w-2 h-2 rounded-full bg-gray-500";
                n.innerText="No Key";
                n.className="opacity-50";
            } 
            debounceSave(); 
        }

        // --- JSON Cleaning ---
        function cleanJson(text) {
            console.log("AI Raw Response:", text); 
            const m = text.match(/```json\s*([\s\S]*?)\s*```/) || text.match(/```\s*([\s\S]*?)\s*```/);
            if (m) { try { return JSON.parse(m[1]); } catch (e) {} }

            const firstOpenBracket = text.indexOf('[');
            const firstOpenBrace = text.indexOf('{');
            let start = -1; let end = -1;
            if (firstOpenBracket !== -1 && (firstOpenBrace === -1 || firstOpenBracket < firstOpenBrace)) {
                start = firstOpenBracket; end = text.lastIndexOf(']');
            } else if (firstOpenBrace !== -1) {
                start = firstOpenBrace; end = text.lastIndexOf('}');
            }
            if (start !== -1 && end !== -1 && end > start) {
                try { return JSON.parse(text.substring(start, end + 1)); } catch (e) { console.error("JSON Parse Failed:", e); }
            }
            throw new Error("AI è¿”å›æ•°æ®æ ¼å¼é”™è¯¯: æ— æ³•è§£æ JSON");
        }

        // --- AI Call Logic ---
        async function callAI(msgs, onChunk) {
            let key = document.getElementById('api-key').value.trim().replace(/[\u4e00-\u9fa5]/g,''); if (!key) throw new Error("è¯·è¾“å…¥ API Key");
            const baseUrl = store.baseUrl || "https://api.deepseek.com/chat/completions";
            let attempt = 0;
            while(attempt <= 2) {
                try {
                    const r = await fetch(baseUrl, { 
                        method: "POST", 
                        headers: { "Content-Type": "application/json", "Authorization": `Bearer ${key}` }, 
                        body: JSON.stringify({ model: "deepseek-chat", messages: msgs, temperature: 1.3, max_tokens: 4000, stream: !!onChunk }) 
                    });
                    
                    if (!r.ok) throw new Error("DeepSeek API Error (è¯·æ£€æŸ¥ Base URL)");
                    
                    if(onChunk) { 
                        const reader = r.body.getReader(); 
                        const decoder = new TextDecoder("utf-8"); 
                        let result = ""; 
                        while (true) { 
                            const { done, value } = await reader.read(); 
                            if (done) break; 
                            const chunk = decoder.decode(value, { stream: true }); 
                            const lines = chunk.split('\n'); 
                            for (const line of lines) { 
                                if (line.startsWith('data: ')) { 
                                    const jsonStr = line.slice(6); 
                                    if (jsonStr === '[DONE]') break; 
                                    try { 
                                        const json = JSON.parse(jsonStr); 
                                        const content = json.choices[0].delta.content || ""; 
                                        result += content; 
                                        onChunk(content); 
                                    } catch (e) {} 
                                } 
                            } 
                        } 
                        return result; 
                    } else { 
                        const d = await r.json(); 
                        return d.choices[0].message.content; 
                    }

                } catch(e) { 
                    attempt++; 
                    if(attempt > 2) throw new Error(`API é”™è¯¯: ${e.message}ã€‚è¯·æ£€æŸ¥ API Key æˆ–ç½‘ç»œã€‚`); 
                    await new Promise(r => setTimeout(r, 1000 * attempt)); 
                }
            }
        }

        async function generateInitialAnalysis() { 
            const p=document.getElementById('novel-prompt').value; if(!p) return showToast("è¾“å…¥æ¢—æ¦‚", "error"); 
            const btn=document.getElementById('btn-gen-idea'); 
            const originalText = btn.innerHTML;
            btn.innerHTML = "â³"; btn.disabled=true; 
            
            const t=(store.tags && store.tags.length>0)?`ç±»å‹æ ‡ç­¾:${store.tags.join(', ')}ã€‚`:""; 
            const m="é•¿ç¯‡è¿è½½æ¨¡å¼"; 
            try { 
                const r=await callAI([{role:"system",content:`${m} ç”Ÿæˆè§’è‰²JSON:[{"name":"","role":"","tags":[],"desc":""}] NO MARKDOWN, RAW JSON ONLY.`},{role:"user",content:`${t} è®¾å®š:${p}`}]); 
                const rawData = cleanJson(r);
                const safeData = Array.isArray(rawData) ? rawData.map(c => ({...c, tags: Array.isArray(c.tags)?c.tags:[]})) : [];
                store.characters=[...store.characters, ...safeData]; 
                renderCharacters(); 
                document.getElementById('section-outline').classList.remove('hidden'); 
                saveData(); 
            } catch(e){showToast(e.message,"error")} finally{btn.innerHTML=originalText; btn.disabled=false;} 
        }

       async function aiGenerateCharacter(btn) {
            const p = document.getElementById('novel-prompt').value;
            if (!p) return showToast("è¯·å…ˆè¾“å…¥æ ¸å¿ƒæ¢—æ¦‚", "error");
            
            const originalText = btn.innerHTML;
            btn.innerHTML = "â³";
            btn.disabled = true;

            try {
                // 1. è·å–é£æ ¼æ ‡ç­¾ï¼Œå¢å¼ºçº¦æŸåŠ›
                const styleTags = store.tags.length > 0 ? store.tags.join('ã€') : "æ— ç‰¹å®šé£æ ¼";
                
                // 2. è·å–å·²æœ‰è§’è‰²åˆ—è¡¨ï¼ˆä»…å–äººåå’Œå…³ç³»ï¼ŒèŠ‚çœ Tokenï¼‰
                const existingChars = store.characters.map(c => `${c.name}(${c.role})`).join('ã€');
                const charContext = existingChars ? `ç°æœ‰è§’è‰²ï¼š${existingChars}ï¼ˆè¯·ç”Ÿæˆä¸ä»–ä»¬æœ‰æ–°å…³ç³»çš„è§’è‰²ï¼‰` : "å½“å‰æ˜¯ç¬¬ä¸€ä¸ªè§’è‰²";

                // 3. æ„å»ºæ›´ä¸“ä¸šçš„ Prompt
                const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ç½‘æ–‡äººè®¾ç­–åˆ’ã€‚
                1. é£æ ¼ä¸¥æ ¼åŒ¹é…æ ‡ç­¾ï¼šã€${styleTags}ã€‘ã€‚ä¸¥ç¦å‡ºç°ä¸ç¬¦åˆæ—¶ä»£èƒŒæ™¯çš„å§“åæˆ–èŒä¸šã€‚
                2. è§’è‰²è¦æœ‰è¾¨è¯†åº¦ï¼Œé¿å…è„¸è°±åŒ–ã€‚
                3. åªè¿”å› RAW JSON æ•°æ®ï¼Œä¸è¦ Markdown æ ¼å¼ã€‚`;

                const userPrompt = `åŸºäºæ ¸å¿ƒæ¢—æ¦‚ï¼š"${p}"ã€‚
                ${charContext}ã€‚
                
                è¯·æ„æ€ 1 ä¸ªæ–°çš„å…³é”®è§’è‰²ã€‚
                æ ¼å¼è¦æ±‚ï¼š
                {
                    "name": "å§“å (ç¬¦åˆèƒŒæ™¯)",
                    "role": "å®šä½ (å¦‚: åæ´¾/æ­»å…š/é‡‘æ‰‹æŒ‡)",
                    "tags": ["æ ‡ç­¾1", "æ ‡ç­¾2"], 
                    "desc": "ç®€è¿° (åŒ…å«æ€§æ ¼ã€å¤–è²Œæˆ–æ ¸å¿ƒå†²çªï¼Œ50å­—ä»¥å†…)"
                }`;

                const res = await callAI([
                    { role: "system", content: systemPrompt },
                    { role: "user", content: userPrompt }
                ]);

                let newChar = cleanJson(res);
                if (Array.isArray(newChar)) newChar = newChar[0];
                if (!newChar.name) throw new Error("AI ç”Ÿæˆæ•°æ®è§£æå¤±è´¥");
                // å®¹é”™å¤„ç†ï¼šç¡®ä¿ tags æ˜¯æ•°ç»„
                if (!Array.isArray(newChar.tags)) newChar.tags = [];

                store.characters.push(newChar);
                renderCharacters();
                saveData();
                initGraph(); 
                showToast(`è§’è‰²ã€${newChar.name}ã€‘å·²ç”Ÿæˆ`, "success");

            } catch (e) {
                console.error(e);
                showToast("æäººå¤±è´¥: " + e.message, "error");
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async function generateMoreOutline() { 
            const c=store.outline.length; const t=parseInt(document.getElementById('target-total-chapters').value); 
            if(c>=t) return showToast("å·²è¾¾ç›®æ ‡","info"); 
            const btn=document.getElementById('btn-add-outline'); const s=document.getElementById('outline-spinner'); 
            btn.disabled=true; btn.querySelector('span').innerText="æ¨æ¼”ä¸­..."; s.classList.remove('hidden'); 
            const ts=(store.tags && store.tags.length>0)?`é£æ ¼æ ‡ç­¾ï¼š${store.tags.join(', ')}`:""; 
            try { 
                const l=c>0?JSON.stringify(store.outline.slice(-5)):"æ— "; 
                const p=`æˆ‘æ˜¯å¤§çº²ç­–åˆ’ã€‚æ ¸å¿ƒï¼š${store.concept}ã€‚ä¸–ç•Œè§‚ï¼š${store.lore}ã€‚${ts}ã€‚è§’è‰²ï¼š${JSON.stringify(store.characters.map(x=>x.name))}ã€‚ç”Ÿæˆç¬¬${c+1}åˆ°${Math.min(c+10,t)}ç« å¤§çº²ã€‚ç´§æ¥ï¼š${l}ã€‚æ ¼å¼ï¼š[{"title":"æ ‡é¢˜","desc":"å‰§æƒ…"}]ã€‚IMPORTANT: RETURN RAW JSON ARRAY ONLY. NO MARKDOWN.`; 
                const r=await callAI([{role:"system",content:p},{role:"user",content:"ç”Ÿæˆ"}]); 
                cleanJson(r).forEach((x,i)=>store.outline.push({id:c+i+1, title:x.title, desc:x.desc})); renderOutline(); saveData(); showToast(`æˆåŠŸå»¶å±•`, "success"); 
            } catch(e){ showToast(e.message,"error"); } finally{ btn.disabled=false; btn.querySelector('span').innerText="+ å»¶å±•å‰§æƒ…"; s.classList.add('hidden'); } 
        }

        function insertLoreTemplate(type) { const t={'ç­‰çº§ä½“ç³»':'\nã€åŠ›é‡ç­‰çº§ã€‘\n1. å‡¡å¢ƒï¼šç»ƒæ°”ã€ç­‘åŸº\n2. çµå¢ƒï¼šå…ƒå©´ã€åŒ–ç¥','åœ°ç†ç¯å¢ƒ':'\nã€ä¸–ç•Œåœ°å›¾ã€‘\nä¸œåŸŸï¼šä¿®ä»™å®—é—¨\nè¥¿æ¼ ï¼šé­”ä¿®','åŠ¿åŠ›ç»„ç»‡':'\nã€ä¸»è¦åŠ¿åŠ›ã€‘\nå¤©é“å®—ï¼šæ­£é“\nè¡€ç…é—¨ï¼šåæ´¾'}; document.getElementById('novel-lore').value+=t[type]||''; if(loreViewMode==='graph') parseLoreToGraph(); debounceSave(); }
async function aiGenLore() { 
            const p = document.getElementById('novel-prompt').value; 
            if(!p) return showToast("è¯·è¾“å…¥æ¢—æ¦‚åå†ä½¿ç”¨å“¦~", "info"); 
            
            document.getElementById('lore-loading').classList.remove('hidden'); 
            
            // --- ä¿®æ”¹å¼€å§‹ï¼šè·å–æ ‡ç­¾å¹¶æ„å»ºæç¤ºè¯ ---
            const currentTags = (store.tags && store.tags.length > 0) ? store.tags.join(', ') : "æ— ç‰¹å®šé£æ ¼";
            
            // æ„å»ºæ›´ä¸¥æ ¼çš„æç¤ºè¯
            const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªç½‘æ–‡ä¸–ç•Œè§‚æ¶æ„å¸ˆã€‚
            1. å¿…é¡»ä¸¥æ ¼åŸºäºç”¨æˆ·æä¾›çš„ã€é£æ ¼æ ‡ç­¾ã€‘å’Œã€æ¢—æ¦‚ã€‘è®¾è®¡ä¸–ç•Œè§‚ã€‚
            2. ä¸¥ç¦å‡ºç°ä¸æ ‡ç­¾ä¸ç¬¦çš„å…ƒç´ ï¼ˆä¾‹å¦‚ï¼šå¦‚æœæ²¡æœ‰"èµ›åšæœ‹å…‹"æ ‡ç­¾ï¼Œç»ä¸è¦å‡ºç°ä¹‰ä½“ã€éœ“è™¹ç¯ã€é»‘å®¢ç­‰å…ƒç´ ï¼›å¦‚æœæ˜¯"å¤ä»£"æ ‡ç­¾ï¼Œä¸è¦å‡ºç°ç°ä»£ç§‘æŠ€ï¼‰ã€‚
            3. ä¿æŒè®¾å®šé€»è¾‘è‡ªæ´½ã€‚`;

            const userContent = `åŸºäºä»¥ä¸‹ä¿¡æ¯ç”Ÿæˆä¸–ç•Œè§‚ï¼ˆç­‰çº§ä½“ç³»ã€åœ°ç†ç¯å¢ƒã€ä¸»è¦åŠ¿åŠ›ï¼‰ã€‚
            
            ã€é£æ ¼æ ‡ç­¾ã€‘ï¼š${currentTags}
            ã€æ ¸å¿ƒæ¢—æ¦‚ã€‘ï¼š${p}
            
            è¾“å‡ºæ ¼å¼è¦æ±‚ï¼š
            ã€å¤§æ ‡é¢˜ã€‘
            åç§°ï¼šæè¿°
            ...`;
            // --- ä¿®æ”¹ç»“æŸ ---

            try { 
                // ä¿®æ”¹è°ƒç”¨æ–¹å¼ï¼Œä¼ å…¥æ›´ä¸°å¯Œçš„ä¸Šä¸‹æ–‡
                const r = await callAI([
                    { role: 'system', content: systemPrompt },
                    { role: 'user', content: userContent }
                ]); 
                
                document.getElementById('novel-lore').value += "\n" + r; 
                if(loreViewMode === 'graph') parseLoreToGraph(); 
                debounceSave(); 
                showToast("æ¨æ¼”å®Œæˆ", "success"); 
            } catch(e) { 
                showToast(e.message, "error"); 
            } finally { 
                document.getElementById('lore-loading').classList.add('hidden'); 
            } 
        }
        function selectChapter(id) { 
            if(!id) return;
            store.currentChapterId = id;
            activateLoom(); 
            document.getElementById('chapter-selector').value = id; 
            loadChapterText(); 
            renderOutline(); 
            
            const ch = store.outline.find(x => x.id == id);
            if(ch) {
                document.getElementById('active-outline-module').classList.remove('hidden');
                document.getElementById('active-outline-title').value = ch.title;
                document.getElementById('active-outline-desc').value = ch.desc;
                document.getElementById('active-outline-words').value = ch.targetWords || store.defaultWordCount || "2000-3000";
            }
        }

        function updateActiveOutlineData() {
            const id = store.currentChapterId;
            if(!id) return;
            const chIndex = store.outline.findIndex(x => x.id == id);
            if(chIndex !== -1) {
                store.outline[chIndex].title = document.getElementById('active-outline-title').value;
                store.outline[chIndex].desc = document.getElementById('active-outline-desc').value;
                store.outline[chIndex].targetWords = document.getElementById('active-outline-words').value;
                saveData();
                renderOutline(); 
            }
        }

       async function generateChapterText(cont) { 
            const id = store.currentChapterId; 
            if(!id) return showToast("è¯·å…ˆåœ¨å·¦ä¸‹è§’é€‰æ‹©ä¸€ä¸ªç« èŠ‚","error"); 
            
            const ch = store.outline.find(x => x.id == id); 
            const ed = document.getElementById('chapter-editor'); 
            const pnl = document.getElementById('loom-panel'); 
            
            pnl.classList.add('generating-glow'); 
            const spin = document.getElementById('loading-overlay'); 
            if(spin) { spin.classList.remove('hidden'); spin.querySelector('p').innerText="AI æ­£åœ¨æ²‰æµ¸åˆ›ä½œä¸­..."; } 
            
            // ä¼˜åŒ– 1ï¼šç²¾ç®€è§’è‰²ä¿¡æ¯ï¼ˆåªå– å§“å+æ ‡ç­¾ï¼Œé˜²æ­¢ Token æº¢å‡ºï¼‰
            const charSummary = store.characters.map(x => `${x.name}[${x.role}]`).join('ï¼Œ');
            
            // ä¼˜åŒ– 2ï¼šæ ¹æ®æ ‡ç­¾å®šåˆ¶æ–‡é£æŒ‡ä»¤
            const tags = store.tags || [];
            let styleInstruction = "æ–‡ç¬”é€šä¿—æµç•…ï¼Œä»£å…¥æ„Ÿå¼ºã€‚";
            if(tags.includes("æ‚¬ç–‘") || tags.includes("ææ€–")) styleInstruction += "æ³¨é‡ç¯å¢ƒæ¸²æŸ“ï¼Œè¥é€ ç´§å¼ å‹æŠ‘çš„æ°›å›´ã€‚";
            else if(tags.includes("çˆ½æ–‡") || tags.includes("çƒ­è¡€")) styleInstruction += "èŠ‚å¥ç´§å‡‘ï¼ŒæœŸå¾…æ„Ÿæ‹‰æ»¡ï¼Œæ³¨é‡æƒ…ç»ªè°ƒåŠ¨ã€‚";
            else if(tags.includes("å¤è¨€") || tags.includes("å†å²")) styleInstruction += "ç”¨è¯å¤é£å…¸é›…ï¼Œç¬¦åˆæ—¶ä»£éŸµå‘³ã€‚";
            
            const wordTarget = ch.targetWords || store.defaultWordCount || "2000-3000";
            
            try { 
                let msg = []; 
                // æˆªå– Lore é˜²æ­¢è¿‡é•¿ (å–å‰ 1000 å­—)
                const shortLore = store.lore.length > 1000 ? store.lore.substring(0, 1000) + "..." : store.lore;

                const systemContent = `ä½ æ˜¯ä¸€ä¸ªé‡‘ç‰Œç½‘æ–‡ä½œå®¶ã€‚
                ã€å†™ä½œç›®æ ‡ã€‘ï¼šå°†å¤§çº²æ‰©å†™ä¸ºç²¾å½©çš„æ­£æ–‡ã€‚
                ã€é£æ ¼è¦æ±‚ã€‘ï¼š${styleInstruction} ä¸¥æ ¼éµå¾ªæ ‡ç­¾ï¼š${tags.join('+')}ã€‚
                ã€æ ¸å¿ƒæ³•åˆ™ã€‘ï¼š
                1. Show, Don't Tell (å¤šç”¨æ„Ÿå®˜æå†™ï¼Œå°‘ç”¨å½¢å®¹è¯å †ç Œ)ã€‚
                2. æ‹’ç»æµæ°´è´¦ï¼Œè¦æœ‰å…·ä½“çš„åœºæ™¯åˆ»ç”»å’Œå¯¹è¯åšå¼ˆã€‚
                3. å­—æ•°ç›®æ ‡ï¼š${wordTarget}å­—å·¦å³ã€‚`;

                if(cont) { 
                    // ç»­å†™æ¨¡å¼ï¼šåªå–æœ«å°¾ 2000 å­—ä½œä¸ºä¸Šä¸‹æ–‡
                    const ctx = ed.value.slice(-2000); 
                    msg = [
                        { role: "system", content: `${systemContent} \nå½“å‰ä»»åŠ¡ï¼šç´§æ¥ä¸Šæ–‡ç»­å†™ï¼Œä¿æŒå‰§æƒ…è¿è´¯ã€‚` },
                        { role: "user", content: `ã€ä¸Šæ–‡å›é¡¾ã€‘...\n${ctx}\n\nã€æœ¬ç« å¤§çº²ã€‘ï¼š${ch.desc}\n\nè¯·ç»§ç»­å†™ï¼š` }
                    ]; 
                } else { 
                    // èµ·ç¬”æ¨¡å¼
                    msg = [
                        { role: "system", content: systemContent },
                        { role: "user", content: `ã€ä¸–ç•Œè§‚ã€‘ï¼š${shortLore}\nã€ç™»åœºè§’è‰²ã€‘ï¼š${charSummary}\n\nã€ç« èŠ‚åã€‘ï¼š${ch.title}\nã€æœ¬ç« å‰§æƒ…ã€‘ï¼š${ch.desc}\n\nè¯·å¼€å§‹åˆ›ä½œæ­£æ–‡ï¼š` }
                    ]; 
                } 
                
                if(spin) spin.classList.add('hidden'); 
                
                // æµå¼è¾“å‡º
                await callAI(msg, (c) => { 
                    ed.value += c; 
                    ed.scrollTop = ed.scrollHeight; 
                    updateWordCount(); 
                }); 
                
                store.chapterTexts[id] = ed.value; 
                saveData(); 
                renderOutline(); 
                
            } catch(e) { 
                showToast(e.message, "error"); 
            } finally { 
                if(pnl) pnl.classList.remove('generating-glow'); 
                if(spin) spin.classList.add('hidden'); 
            } 
        }

        async function aiBrainstormTags() { const p=document.getElementById('novel-prompt').value; if(!p) return showToast("è¯·è¾“å…¥æ¢—æ¦‚åå†ä½¿ç”¨å“¦~", "info"); showToast("åˆ†æä¸­...", "info"); try { const r=await callAI([{role:'user', content:`åŸºäºæ¢—æ¦‚æ¨è5-8ä¸ªæ ‡ç­¾ã€‚JSONæ•°ç»„æ ¼å¼ã€‚æ¢—æ¦‚ï¼š${p}`}]); const t=cleanJson(r); if(Array.isArray(t)) { let c=0; t.forEach(x=>{if(!store.tags.includes(x)){store.tags.push(x);c++;}}); renderSelectedTags(); renderTagSelector(); saveData(); showToast(`æ·»åŠ  ${c} ä¸ªæ ‡ç­¾`, "success"); } } catch(e) { showToast(e.message, "error"); } }
        
        function renderCharacters() { 
            const l = document.getElementById('character-list'); 
            if (!l) return; 
            
            l.innerHTML = store.characters.map((c, i) => `
                <div class="glass-panel p-3 rounded-xl relative group hover:bg-[var(--panel-bg)] border border-[var(--panel-border)] shadow-sm flex flex-col gap-2 transition-all hover:-translate-y-1 hover:shadow-md hover:border-indigo-500/30">
                    <div class="flex justify-between items-start">
                        <span class="font-bold text-accent text-sm truncate pr-2">${c.name}</span>
                        <span class="text-[10px] opacity-60 bg-black/20 px-1.5 py-0.5 rounded text-sub border border-[var(--panel-border)] whitespace-nowrap max-w-[45%] truncate">${c.role}</span>
                    </div>
                    
                    <div class="text-[10px] text-sub line-clamp-3 leading-relaxed opacity-80 bg-black/5 p-1.5 rounded-lg min-h-[3.5em]">
                        ${c.desc || 'æš‚æ— æè¿°...'}
                    </div>

                    <button onclick="store.characters.splice(${i},1);renderCharacters();saveData();initGraph()" class="absolute -top-2 -right-2 w-5 h-5 bg-red-500/80 hover:bg-red-500 rounded-full text-white flex items-center justify-center text-xs opacity-100 md:opacity-0 group-hover:opacity-100 transition shadow-md backdrop-blur-sm z-10">Ã—</button>
                </div>
            `).join(''); 
        }

        function renderOutline() { const c=document.getElementById('outline-container'); const e=document.getElementById('outline-empty-state'); const p=document.getElementById('chapter-progress-text'); const t=document.getElementById('target-total-chapters').value; p.innerText=`${store.outline.length}/${t}`; if(store.outline.length===0){c.innerHTML='';e.classList.remove('hidden');return;}else{e.classList.add('hidden');} c.innerHTML=store.outline.map((ch,i)=>{ const has=store.chapterTexts[ch.id]&&store.chapterTexts[ch.id].length>0; const b=has?`<span class="text-[10px] bg-emerald-500/20 text-emerald-500 px-2 py-0.5 rounded-full border border-emerald-500/30">âœ… å·²å†™</span>`:`<span class="text-[10px] bg-[var(--input-bg)] text-sub px-2 py-0.5 rounded-full border border-[var(--panel-border)] opacity-60">â³ å¾…å†™</span>`; const sel=store.currentChapterId==ch.id?'card-active scale-[1.02]':''; return `<div class="glass-panel p-4 md:p-5 rounded-2xl cursor-pointer hover:bg-[var(--panel-bg)] transition-all group highlight-card relative overflow-hidden shadow-sm hover:shadow-md hover:-translate-y-1 ${sel}" onclick="selectChapter(${ch.id})"><div class="absolute -right-2 -top-5 text-[4rem] md:text-[5rem] font-bold opacity-[0.03] text-main pointer-events-none mono-font select-none">${String(i+1).padStart(2,'0')}</div><div class="relative z-10"><div class="flex justify-between items-start mb-3"><span class="text-xs font-bold opacity-50 tracking-wider text-sub">CH ${i+1}</span>${b}</div><h3 class="text-sm font-bold text-main truncate mb-2 group-hover:text-accent transition-colors leading-relaxed">${ch.title}</h3><p class="text-xs text-sub leading-relaxed line-clamp-3 opacity-80">${ch.desc}</p></div></div>`; }).join(''); const sel=document.getElementById('chapter-selector'); const val=sel.value; sel.innerHTML='<option value="">é€‰æ‹©ç« èŠ‚...</option>'+store.outline.map(ch=>`<option value="${ch.id}">${ch.title}</option>`).join(''); if(val) sel.value=val; }
        function updateProgressUI() { document.getElementById('chapter-progress-text').innerText=`${store.outline.length}/${document.getElementById('target-total-chapters').value}`; }
        function activateLoom() { document.getElementById('section-loom').classList.remove('hidden'); document.getElementById('section-loom').scrollIntoView({behavior:'smooth'}); }
        function loadChapterText() { const id=document.getElementById('chapter-selector').value; store.currentChapterId=id; document.getElementById('chapter-editor').value=(id&&store.chapterTexts[id])?store.chapterTexts[id]:""; updateWordCount(); }
        function updateWordCount() { document.getElementById('current-word-count').innerText=document.getElementById('chapter-editor').value.length+" Words"; }
        function addManualCharacter() { const n=document.getElementById('new-char-name').value; if(!n) return; store.characters.push({name:n, role:document.getElementById('new-char-role').value, tags:document.getElementById('new-char-tags').value.split(/[,ï¼Œ]/), desc:document.getElementById('new-char-desc').value}); renderCharacters(); saveData(); toggleModal('char-modal'); initGraph(); }

        // --- å…¬å‘Šä¸å…è´£å£°æ˜ ---
        function checkAndAutoPopAnnouncements() { const r = JSON.parse(localStorage.getItem('read_announcements') || '[]'); if(!r.includes(999)) toggleAnnouncements(); }
        function toggleAnnouncements() { const m=document.getElementById('announcement-modal'); const l=document.getElementById('announcement-list'); const dot=document.getElementById('notification-dot'); if(m.classList.contains('hidden')) { m.classList.remove('hidden'); dot.classList.add('hidden'); l.innerHTML = systemAnnouncements.map(a => { const r = JSON.parse(localStorage.getItem('read_announcements')||'[]').includes(a.id); let c=a.type==='important'?'announcement-important':'border border-[var(--panel-border)] bg-[var(--input-bg)]'; let b=a.type==='important'?`<span class="bg-amber-500 text-black px-2 rounded font-bold text-xs animate-pulse">å¿…è¯»</span>`:`<span class="bg-indigo-500 text-white px-2 rounded text-xs">æ›´æ–°</span>`; return `<div class="p-4 rounded-lg mb-3 ${c} ${r&&a.type!=='important'?'opacity-50':''}"><div class="flex justify-between mb-2"><div class="flex gap-2 items-center">${b} <span class="font-bold text-main">${a.title}</span></div><span class="text-xs text-sub">${a.date}</span></div><div class="text-sm text-sub leading-relaxed pl-1 opacity-90">${a.content}</div></div>`; }).join(''); } else m.classList.add('hidden'); }
        function markAllAsRead() { const ids=systemAnnouncements.map(a=>a.id); localStorage.setItem('read_announcements', JSON.stringify(ids)); toggleAnnouncements(); }
        function showDisclaimer(r) { document.getElementById('disclaimer-modal').classList.remove('hidden'); if(!r) document.getElementById('main-content').classList.add('blur-content'); }
        function acceptDisclaimer() { localStorage.setItem('agreed_to_terms_v1', 'true'); document.getElementById('disclaimer-modal').classList.add('hidden'); document.getElementById('main-content').classList.remove('blur-content'); showToast("æ¬¢è¿ä½¿ç”¨", "success"); setTimeout(checkAndAutoPopAnnouncements, 500); }
        function toggleTutorial() { document.getElementById('tutorial-modal').classList.toggle('hidden'); }
        let petState = 'idle'; let petTimer;
        function petInteract() { const pet = document.getElementById('pet-body'); const bubble = document.getElementById('pet-bubble'); pet.classList.add('pet-happy'); const msgs = ["åŠ æ²¹å‘€ï¼", "ä½ æ˜¯æœ€æ£’çš„ï¼", "è¿™é‡Œå‰§æƒ…ä¸é”™~", "è®°å¾—å­˜ç¨¿å“¦", "å–å£æ°´å§", "çµæ„Ÿ+1", "DeepSeek ä¹Ÿå¾ˆå–œæ¬¢è¿™ç« ï¼"]; bubble.innerText = msgs[Math.floor(Math.random()*msgs.length)]; bubble.classList.add('show'); setTimeout(() => { pet.classList.remove('pet-happy'); bubble.classList.remove('show'); }, 2000); }
        function petHappy() { const pet = document.getElementById('pet-body'); if(!pet.classList.contains('pet-happy')) { pet.classList.add('pet-happy'); setTimeout(() => pet.classList.remove('pet-happy'), 1000); } clearTimeout(petTimer); }
        document.addEventListener('mousemove', (e) => { const eyes = document.querySelectorAll('.pet-eye'); eyes.forEach(eye => { const rect = eye.getBoundingClientRect(); const x = rect.left + rect.width / 2; const y = rect.top + rect.height / 2; const rad = Math.atan2(e.clientX - x, e.clientY - y); const rot = (rad * (180 / Math.PI) * -1) + 180; eye.style.transform = `rotate(${rot}deg)`; }); });
        function togglePet() { const c = document.getElementById('pet-container'); c.style.display = c.style.display === 'none' ? 'block' : 'none'; }
    </script>
</body>
</html>
